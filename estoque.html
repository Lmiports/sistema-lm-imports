<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V칄RTICE BI | CORE</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="logo.png" type="image/png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        /* --- PADR츾O VISUAL V칄RTICE BI CORE --- */
        :root { 
            --bg: #020617; --card: #0f172a; --accent: #00e0ff; --border: #1e293b; 
            --text: #f8fafc; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; 
        }
        
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; min-height: 100vh; overflow-y: auto; user-select: none; }
        
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .btn-home { background: #1e293b; color: #fff; padding: 8px 15px; border-radius: 6px; font-size: 14px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--border); font-weight: bold; transition: 0.3s; cursor: pointer; }
        .page-title { font-size: 18px; font-weight: bold; color: var(--accent); letter-spacing: 1px; margin: 0; }
        .version-tag { font-size: 10px; color: #000; background: var(--accent); padding: 2px 6px; border-radius: 4px; margin-left: 10px; font-weight: 900; vertical-align: middle; }
        
        .content { padding: 20px; display: grid; grid-template-columns: 1fr 1.3fr; gap: 20px; max-width: 1400px; margin: 0 auto; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; height: fit-content; }
        .card-header { padding: 15px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 14px; font-weight: bold; color: var(--accent); text-transform: uppercase; margin: 0; }

        .filter-tabs { display: flex; gap: 5px; padding: 10px 15px; border-bottom: 1px solid var(--border); overflow-x: auto; white-space: nowrap; }
        .f-tab { padding: 6px 12px; background: #1e293b; border-radius: 15px; font-size: 11px; cursor: pointer; color: #94a3b8; border: 1px solid transparent; transition:0.2s; }
        .f-tab.active { background: var(--accent); color: #000; border-color: var(--accent); }

        .search-box { padding: 10px 15px; border-bottom: 1px solid var(--border); }
        input, select { width: 100%; padding: 12px; background: #020617; border: 1px solid var(--border); border-radius: 8px; color: #fff; box-sizing: border-box; outline: none; transition: 0.3s; font-size: 13px; }
        
        .item-list { max-height: 600px; overflow-y: auto; flex: 1; }
        .item-row { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .item-row:hover { background: rgba(0, 224, 255, 0.1); }
        .item-row.active { background: var(--accent); color: #000; }
        
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; text-transform: uppercase; }
        .badge-celular { background: var(--accent); color: #000; }
        .badge-roupa { background: #ec4899; color: #fff; }
        .badge-acessorio { background: #8b5cf6; color: #fff; }
        .badge-perfume { background: #f59e0b; color: #fff; }
        .badge-qtd { background: #334155; color: #fff; border: 1px solid #475569; margin-left: 5px; }

        .form-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .label { font-size: 11px; color: #64748b; margin-bottom: 5px; display: block; text-transform: uppercase; }
        
        .btn-group { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; background: var(--card); }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-save { background: var(--success); color: #000; }
        .btn-new { background: var(--accent); color: #000; }
        .btn-del { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-manage { background: #334155; color: #fff; font-size: 10px; padding: 8px; flex: 1; }
        .btn-clean { background: rgba(239, 68, 68, 0.2); color: var(--danger); font-size: 10px; padding: 8px; border: 1px solid var(--danger); flex: 1; }

        .hidden { display: none !important; }
        .footer { text-align: center; padding: 20px; color: #64748b; font-size: 11px; border-top: 1px solid var(--border); margin-top: 20px; width: 100%; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: var(--card); border: 1px solid var(--accent); padding: 20px; border-radius: 12px; width: 400px; max-height: 80vh; display: flex; flex-direction: column; }
        .list-manage-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--border); }
        .btn-mini-del { color: var(--danger); cursor: pointer; }
        optgroup { color: var(--accent); font-weight: bold; background: #000; }

        @media (max-width: 900px) {
            .content { display: flex; flex-direction: column; padding: 10px; }
            .card:first-child { max-height: 400px; }
            .form-grid { grid-template-columns: 1fr; }
            .btn-group { flex-direction: column-reverse; }
        }
    </style>
</head>
<body>

    <div class="header-top">
        <div class="header-left">
            <div onclick="window.location.href='menu.html'" class="btn-home"><i class="fas fa-home"></i> MENU</div>
            <h1 class="page-title">V칄RTICE BI <span class="version-tag">CORE v11.8</span></h1>
        </div>
        <div></div>
    </div>

    <main class="content">
        <section class="card">
            <div class="card-header">
                <h3 class="card-title">Invent치rio</h3>
                <span style="font-size:10px; color:#64748b" id="total-itens">0 itens</span>
            </div>
            
            <div class="filter-tabs">
                <div class="f-tab active" onclick="filtrarCategoria('todos', this)">Todos</div>
                <div class="f-tab" onclick="filtrarCategoria('celular', this)">Celulares</div>
                <div class="f-tab" onclick="filtrarCategoria('roupa', this)">Roupas</div>
                <div class="f-tab" onclick="filtrarCategoria('perfume', this)">Perfumes</div>
                <div class="f-tab" onclick="filtrarCategoria('acessorio', this)">Acess칩rios</div>
            </div>

            <div class="search-box">
                <input type="text" id="busca" placeholder="游댌 Buscar modelo, imei..." onkeyup="filtrarLista()">
            </div>
            
            <div class="item-list" id="lista-estoque">
                <div style="padding:20px; text-align:center; color:#64748b;">Carregando...</div>
            </div>
            
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; gap:10px; flex-direction: column;">
                <button class="btn btn-new" style="width:100%;" onclick="novoItem()">+ PRODUTO</button>
                <div style="display:flex; gap:5px; width:100%; justify-content:space-between;">
                    <button class="btn btn-manage" onclick="abrirModalGestao()"><i class="fas fa-cog"></i> LISTAS</button>
                    <button class="btn btn-clean" onclick="limparVendidos()"><i class="fas fa-trash-alt"></i> LIMPAR VENDIDOS</button>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-edit"></i> Dados do Produto</h3>
                <input type="hidden" id="itemId">
            </div>
            
            <div class="form-body">
                <div class="form-grid">
                    <div>
                        <label class="label">Categoria</label>
                        <select id="categoria" onchange="ajustarCampos()">
                            <option value="celular">Celular / iPhone</option>
                            <option value="roupa">Roupa</option>
                            <option value="perfume">Perfume</option>
                            <option value="acessorio">Acess칩rio</option>
                            <option value="eletronico">Eletr칪nico</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Fornecedor</label>
                        <input type="text" id="fornecedor" placeholder="Origem" list="dlFornecedores">
                    </div>
                </div>

                <div>
                    <label class="label">Marca</label>
                    <input type="text" id="marca" placeholder="Apple..." list="dlMarcas">
                </div>

                <div>
                    <label class="label" id="labelModelo">Modelo / Nome <span style="color:red">*</span></label>
                    <input type="text" id="modelo" placeholder="Ex: iPhone 14 Pro Max">
                </div>

                <div class="form-grid">
                    <div>
                        <label class="label" style="color:var(--danger)">Custo (R$)</label>
                        <input type="text" id="custo" style="color:var(--danger);font-weight:bold;" placeholder="0,00" onkeyup="moeda(this)">
                    </div>
                    <div>
                        <label class="label" style="color:var(--success)">Venda (R$)</label>
                        <input type="text" id="venda" style="color:var(--success);font-weight:bold;" placeholder="0,00" onkeyup="moeda(this)">
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid var(--border); width:100%;">

                <div id="campos-celular">
                    <div class="form-grid">
                        <div>
                            <label class="label">Armazenamento</label>
                            <select id="gb">
                                <option value="64GB">64 GB</option>
                                <option value="128GB">128 GB</option>
                                <option value="256GB">256 GB</option>
                                <option value="512GB">512 GB</option>
                                <option value="1TB">1 TB</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Cor</label>
                            <input type="text" id="cor" placeholder="Ex: Deep Purple" list="dlCoresCelular">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div>
                            <label class="label">Serial Number</label>
                            <input type="text" id="serial" style="text-transform:uppercase;">
                        </div>
                        <div>
                            <label class="label">Bateria (%)</label>
                            <input type="number" id="bateria" placeholder="100">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div>
                            <label class="label">IMEI 1</label>
                            <input type="text" id="imei1" maxlength="15" oninput="numeros(this)">
                        </div>
                        <div>
                            <label class="label">IMEI 2</label>
                            <input type="text" id="imei2" maxlength="15" oninput="numeros(this)">
                        </div>
                    </div>
                </div>

                <div id="campos-roupa" class="hidden">
                    <div class="form-grid">
                        <div>
                            <label class="label">Tamanho</label>
                            <select id="tamanho">
                                <option value="">-</option>
                                <option value="PP">PP</option>
                                <option value="P">P</option>
                                <option value="M">M</option>
                                <option value="G">G</option>
                                <option value="GG">GG</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Tipo / Tecido</label>
                            <input type="text" id="corRoupa" placeholder="Ex: Jeans, Algod칚o" list="dlTiposRoupa">
                        </div>
                    </div>
                </div>

                <div id="campos-perfume" class="hidden">
                    <div class="form-grid">
                        <div>
                            <label class="label">Volume</label>
                            <input type="text" id="ml" placeholder="Ex: 100ml">
                        </div>
                        <div>
                            <label class="label">Tipo de Fragr칙ncia</label>
                            <input type="text" id="tipoPerfume" placeholder="Selecione..." list="dlFragrancias">
                        </div>
                    </div>
                </div>

                <div class="form-grid" style="margin-top:15px;">
                    <div>
                        <label class="label">Status</label>
                        <select id="status">
                            <option value="dispon칤vel">游릭 Dispon칤vel</option>
                            <option value="vendido">游댮 Vendido</option>
                            <option value="reservado">游리 Reservado</option>
                        </select>
                    </div>
                    <div>
                        <label class="label" style="color:var(--accent)">Quantidade (Lote)</label>
                        <input type="number" id="qtd" min="1" value="1" placeholder="1" style="font-weight:bold; border-color:var(--accent);">
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-del" onclick="deletarItem()"><i class="fas fa-trash"></i></button>
                <button class="btn btn-save" onclick="salvarItem()"><i class="fas fa-save"></i> SALVAR</button>
            </div>
        </section>

        <div class="footer" style="grid-column: 1 / -1;">
            V칄RTICE BI CORE v11.8 춸 Rodrigo N Carvalho 2026
        </div>

        <datalist id="dlMarcas"></datalist>
        <datalist id="dlFornecedores"></datalist>
        <datalist id="dlModelosCelular"></datalist>
        <datalist id="dlCoresCelular"></datalist>
        <datalist id="dlModelosRoupa"></datalist>
        <datalist id="dlTiposRoupa"></datalist>
        <datalist id="dlNomesPerfume"></datalist>
        <datalist id="dlFragrancias"></datalist>
    </main>

    <div id="modalListas" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Gerenciar Listas</h3>
                <button onclick="fecharModalGestao()" style="background:none; border:none; color:white; cursor:pointer;">X</button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <select id="selListaGerenciar" onchange="carregarItensLista()" style="flex:1;">
                    <optgroup label="GERAL">
                        <option value="lista_marcas">Marcas (Geral)</option>
                    </optgroup>
                    <optgroup label="CELULARES">
                        <option value="lista_modelos_cel">Modelos (iPhones)</option>
                        <option value="lista_cores_cel">Cores</option>
                    </optgroup>
                    <optgroup label="ROUPAS">
                        <option value="lista_modelos_roupa">Modelos (Cal칞a/Camisa)</option>
                        <option value="lista_tipos_roupa">Tipos/Tecidos</option>
                    </optgroup>
                    <optgroup label="PERFUMES">
                        <option value="lista_nomes_perfume">Nomes de Perfume</option>
                        <option value="lista_fragrancias">Fragr칙ncias</option>
                    </optgroup>
                </select>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="novoItemLista" placeholder="Novo Item...">
                <button class="btn btn-save" style="width:auto;" onclick="adicionarItemLista()">+</button>
            </div>
            <div id="containerItensLista" class="modal-body"></div>
        </div>
    </div>

    <script>
        // --- 游 KILL SWITCH ---
        const DATA_LIMITE = new Date('2030-01-01'); 
        if(new Date() > DATA_LIMITE) { 
            throw new Error("Bloqueado"); 
        }

        let dbEstoque = [];
        let itemSelecionadoId = null;
        let filtroCatAtual = 'todos';

        window.onload = () => {
            const cargo = localStorage.getItem('cargoUsuario');
            if(!cargo) window.location.href='index.html';

            db.collection("estoque").orderBy("modelo").onSnapshot(snap => {
                dbEstoque = [];
                snap.forEach(doc => dbEstoque.push({ id: doc.id, ...doc.data() }));
                renderizarLista();
            });
            
            carregarDatalist('fornecedores', 'dlFornecedores');
            carregarDatalist('lista_marcas', 'dlMarcas');
            carregarDatalist('lista_modelos_cel', 'dlModelosCelular');
            carregarDatalist('lista_cores_cel', 'dlCoresCelular');
            carregarDatalist('lista_modelos_roupa', 'dlModelosRoupa');
            carregarDatalist('lista_tipos_roupa', 'dlTiposRoupa');
            carregarDatalist('lista_nomes_perfume', 'dlNomesPerfume');
            carregarDatalist('lista_fragrancias', 'dlFragrancias');
            ajustarCampos(); 
        };

        // --- FUN칂츾O DE RENDERIZA칂츾O COM AGRUPAMENTO INTELIGENTE ---
        function renderizarLista() {
            const div = document.getElementById('lista-estoque');
            div.innerHTML = "";
            const termo = document.getElementById('busca').value.toLowerCase();
            
            // 1. FILTRAR
            const filtrados = dbEstoque.filter(p => {
                const texto = (p.modelo + (p.imei1 || '') + (p.serial || '')).toLowerCase();
                const matchTexto = texto.includes(termo);
                const matchCat = filtroCatAtual === 'todos' || (p.categoria || '').toLowerCase().includes(filtroCatAtual);
                return matchTexto && matchCat;
            });

            document.getElementById('total-itens').innerText = `${filtrados.length} itens`;

            // 2. L칍GICA DE AGRUPAMENTO
            const listaFinal = [];
            const grupos = {}; // Objeto para armazenar grupos

            filtrados.forEach(p => {
                const cat = (p.categoria || '').toLowerCase();
                
                // SE FOR CELULAR OU SE ESTIVER VENDIDO/RESERVADO -> N츾O AGRUPA (MOSTRA INDIVIDUAL)
                if(cat.includes('celular') || p.status !== 'dispon칤vel') {
                    listaFinal.push({ tipo: 'individual', dados: p });
                } 
                else {
                    // SE FOR OUTROS (Perfume, Roupa, Capa) -> TENTA AGRUPAR
                    // Chave 칰nica: Modelo + Valor + Cor + Tamanho
                    const chave = `${p.modelo}-${p.venda}-${p.cor||''}-${p.tamanho||''}`;
                    
                    if(!grupos[chave]) {
                        grupos[chave] = { tipo: 'grupo', count: 0, dados: p, ids: [] };
                        listaFinal.push(grupos[chave]); // Adiciona refer칡ncia na lista
                    }
                    grupos[chave].count++;
                    grupos[chave].ids.push(p.id); // Guarda os IDs do grupo
                }
            });

            // 3. DESENHAR NA TELA
            listaFinal.forEach(item => {
                const el = document.createElement('div');
                const p = item.dados;
                
                // Se for grupo, usa o ID do primeiro item para carregar ao clicar
                const clickId = item.tipo === 'grupo' ? item.ids[0] : p.id;
                // Se item selecionado for um dos itens do grupo, marca o grupo como ativo
                const isActive = itemSelecionadoId === p.id || (item.tipo === 'grupo' && item.ids.includes(itemSelecionadoId));

                el.className = `item-row ${isActive ? 'active' : ''}`;
                
                // Ao clicar no grupo, carrega o PRIMEIRO item individualmente (para editar/reservar)
                // Se salvar como "reservado", ele sai do grupo na pr칩xima renderiza칞칚o. Genial!
                el.onclick = () => carregarItem(item.tipo === 'grupo' ? buscarPorId(item.ids[0]) : p);

                const cat = (p.categoria || 'outros').toLowerCase();
                let badgeClass = 'badge-acessorio';
                if(cat.includes('celular')) badgeClass = 'badge-celular';
                if(cat.includes('roupa')) badgeClass = 'badge-roupa';
                if(cat.includes('perfume')) badgeClass = 'badge-perfume';

                let nome = p.modelo || p.nomeP || 'Sem nome';
                if(p.gb) nome += ` ${p.gb}`;

                // BADGE DE QUANTIDADE SE FOR GRUPO
                let badgeQtd = item.tipo === 'grupo' && item.count > 1 
                    ? `<span class="badge badge-qtd">${item.count} UNIDADES</span>` 
                    : '';

                el.innerHTML = `
                    <div>
                        <div style="display:flex; gap:5px; margin-bottom:4px;">
                            <span class="badge ${badgeClass}">${cat.toUpperCase()}</span>
                            ${badgeQtd}
                            ${p.status === 'vendido' ? '<span class="badge" style="background:#ef4444;color:#fff;">VENDIDO</span>' : ''}
                            ${p.status === 'reservado' ? '<span class="badge" style="background:#f59e0b;color:#fff;">RESERVADO</span>' : ''}
                        </div>
                        <div style="font-weight:600;">${nome}</div>
                        <div style="font-size:11px; opacity:0.7;">${p.cor || p.tamanho || p.ml || ''}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold;">R$ ${parseFloat(p.venda||0).toFixed(2)}</div>
                    </div>
                `;
                div.appendChild(el);
            });
        }

        function buscarPorId(id) {
            return dbEstoque.find(i => i.id === id);
        }

        function filtrarCategoria(cat, el) {
            filtroCatAtual = cat;
            document.querySelectorAll('.f-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderizarLista();
        }
        function filtrarLista() { renderizarLista(); }

        // --- RESTO DAS FUN칂칏ES (IGUAIS) ---
        function ajustarCampos() {
            const cat = document.getElementById('categoria').value;
            const inputModelo = document.getElementById('modelo');
            const labelModelo = document.getElementById('labelModelo');

            document.getElementById('campos-celular').classList.add('hidden');
            document.getElementById('campos-roupa').classList.add('hidden');
            document.getElementById('campos-perfume').classList.add('hidden');
            inputModelo.removeAttribute('list');

            if(cat === 'celular') {
                document.getElementById('campos-celular').classList.remove('hidden');
                inputModelo.setAttribute('list', 'dlModelosCelular');
                labelModelo.innerText = "Modelo (iPhone)";
            } else if(cat === 'roupa') {
                document.getElementById('campos-roupa').classList.remove('hidden');
                inputModelo.setAttribute('list', 'dlModelosRoupa');
                labelModelo.innerText = "Modelo (Cal칞a, Camisa...)";
            } else if(cat === 'perfume') {
                document.getElementById('campos-perfume').classList.remove('hidden');
                inputModelo.setAttribute('list', 'dlNomesPerfume');
                labelModelo.innerText = "Nome do Perfume";
            } else {
                labelModelo.innerText = "Descri칞칚o do Item";
            }
        }

        function carregarItem(p) {
            itemSelecionadoId = p.id; // Marca o ID espec칤fico que foi carregado
            document.getElementById('itemId').value = p.id;
            
            document.getElementById('categoria').value = p.categoria || 'celular';
            document.getElementById('fornecedor').value = p.fornecedor || '';
            document.getElementById('marca').value = p.marca || '';
            document.getElementById('modelo').value = p.modelo || p.nomeP || '';
            document.getElementById('custo').value = formatMoney(p.custo);
            document.getElementById('venda').value = formatMoney(p.venda);
            document.getElementById('status').value = p.status || 'dispon칤vel';
            document.getElementById('qtd').value = 1; 
            
            ajustarCampos();

            document.getElementById('gb').value = p.gb || '128GB';
            document.getElementById('cor').value = p.cor || '';
            document.getElementById('serial').value = p.serial || '';
            document.getElementById('bateria').value = p.bateria || '';
            document.getElementById('imei1').value = p.imei1 || '';
            document.getElementById('imei2').value = p.imei2 || '';
            document.getElementById('tamanho').value = p.tamanho || '';
            document.getElementById('corRoupa').value = p.cor || '';
            document.getElementById('ml').value = p.ml || '';
            document.getElementById('tipoPerfume').value = p.fragrancia || '';

            renderizarLista(); // Re-renderiza para atualizar a classe .active
            
            if(window.innerWidth <= 900) {
                document.querySelector('.form-body').scrollIntoView({behavior: "smooth"});
            }
        }

        function novoItem() {
            itemSelecionadoId = null;
            document.getElementById('itemId').value = "";
            document.getElementById('modelo').value = "";
            document.getElementById('marca').value = "";
            document.getElementById('fornecedor').value = "";
            document.getElementById('custo').value = "";
            document.getElementById('venda').value = "";
            document.getElementById('serial').value = "";
            document.getElementById('bateria').value = "";
            document.getElementById('imei1').value = "";
            document.getElementById('imei2').value = "";
            document.getElementById('tipoPerfume').value = "";
            document.getElementById('status').value = "dispon칤vel";
            document.getElementById('qtd').value = "1";
            document.getElementById('cor').value = "";
            document.getElementById('corRoupa').value = "";
            document.getElementById('modelo').focus();
            renderizarLista();
        }

        async function salvarItem() {
            const id = document.getElementById('itemId').value;
            const cat = document.getElementById('categoria').value;
            const qtd = parseInt(document.getElementById('qtd').value) || 1;
            
            const dados = {
                categoria: cat,
                fornecedor: document.getElementById('fornecedor').value,
                marca: document.getElementById('marca').value,
                modelo: document.getElementById('modelo').value,
                custo: parseMoney(document.getElementById('custo').value),
                venda: parseMoney(document.getElementById('venda').value),
                status: document.getElementById('status').value,
                nomeP: document.getElementById('modelo').value
            };

            if (cat === 'celular') {
                dados.gb = document.getElementById('gb').value;
                dados.cor = document.getElementById('cor').value;
                dados.imei1 = document.getElementById('imei1').value;
                dados.imei2 = document.getElementById('imei2').value;
                dados.serial = document.getElementById('serial').value.toUpperCase();
                dados.bateria = document.getElementById('bateria').value;
            } else if (cat === 'roupa') {
                dados.tamanho = document.getElementById('tamanho').value;
                dados.cor = document.getElementById('corRoupa').value;
            } else if (cat === 'perfume') {
                dados.ml = document.getElementById('ml').value;
                dados.fragrancia = document.getElementById('tipoPerfume').value;
            }

            if(!dados.modelo) return alert("Modelo 칠 obrigat칩rio");

            try {
                if(id) {
                    await db.collection("estoque").doc(id).update(dados);
                    alert("Item atualizado!");
                } else {
                    dados.dataEntrada = Date.now();
                    const promessas = [];
                    for(let i = 0; i < qtd; i++) {
                        promessas.push(db.collection("estoque").add(dados));
                    }
                    await Promise.all(promessas);
                    novoItem();
                    alert(`${qtd} item(ns) cadastrado(s)!`);
                }
            } catch(e) { alert("Erro: " + e.message); }
        }

        async function deletarItem() {
            const id = document.getElementById('itemId').value;
            if(!id) return;
            if(confirm("Excluir item?")) {
                await db.collection("estoque").doc(id).delete();
                novoItem();
                alert("Exclu칤do.");
            }
        }

        async function limparVendidos() {
            if(!confirm("Deseja limpar itens vendidos?")) return;
            const snap = await db.collection("estoque").where("status", "==", "vendido").get();
            const batch = db.batch();
            snap.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            alert("Limpeza conclu칤da!");
        }

        // Listas e Auxiliares
        function abrirModalGestao() { document.getElementById('modalListas').style.display = 'flex'; carregarItensLista(); }
        function fecharModalGestao() { document.getElementById('modalListas').style.display = 'none'; }
        
        async function carregarItensLista() {
            const colecao = document.getElementById('selListaGerenciar').value;
            const container = document.getElementById('containerItensLista');
            container.innerHTML = "Carregando...";
            const snap = await db.collection(colecao).orderBy('nome').get();
            container.innerHTML = "";
            snap.forEach(doc => {
                container.innerHTML += `<div class="list-manage-item"><span>${doc.data().nome}</span><span class="btn-mini-del" onclick="removerItemLista('${colecao}', '${doc.id}')"><i class="fas fa-trash"></i></span></div>`;
            });
        }
        async function adicionarItemLista() {
            const col = document.getElementById('selListaGerenciar').value;
            const val = document.getElementById('novoItemLista').value.trim();
            if(val) { await db.collection(col).add({nome:val}); document.getElementById('novoItemLista').value=""; carregarItensLista(); }
        }
        async function removerItemLista(col, id) { if(confirm("Remover?")) { await db.collection(col).doc(id).delete(); carregarItensLista(); } }
        function carregarDatalist(col, id) {
            db.collection(col).orderBy('nome').onSnapshot(s => {
                document.getElementById(id).innerHTML = "";
                s.forEach(d => document.getElementById(id).innerHTML += `<option value="${d.data().nome}">`);
            });
        }
        function moeda(i) { let v = i.value.replace(/\D/g,''); v = (v/100).toFixed(2)+''; v = v.replace(".",",").replace(/(\d)(\d{3}),/g,"$1.$2,"); i.value = "R$ "+v; }
        function numeros(i) { i.value = i.value.replace(/\D/g,''); }
        function formatMoney(val) { return val ? "R$ "+parseFloat(val).toFixed(2).replace('.',',') : ""; }
        function parseMoney(val) { return parseFloat(val.replace(/[R$\s.]/g,'').replace(',','.')) || 0; }
    </script>
</body>
</html>
