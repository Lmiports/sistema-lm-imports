<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Diagn√≥stico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        :root { --bg: #020617; --accent: #ef4444; /* Vermelho para indicar modo teste */ --text: #f8fafc; --glass: rgba(15, 23, 42, 0.6); --border: rgba(255, 255, 255, 0.1); }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg); height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; color: var(--text); }
        .login-card { background: var(--glass); backdrop-filter: blur(20px); border: 2px solid var(--accent); padding: 40px; border-radius: 20px; text-align: center; width: 100%; max-width: 400px; }
        input { width: 100%; padding: 15px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); border-radius: 10px; color: #fff; margin-bottom: 15px; box-sizing: border-box; }
        .btn-login { width: 100%; padding: 15px; background: var(--accent); border: none; border-radius: 10px; color: #fff; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-login:hover { opacity: 0.9; }
        .aviso-teste { color: var(--accent); font-size: 12px; margin-bottom: 20px; font-weight: bold; border: 1px dashed var(--accent); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="login-card">
        <h2 style="margin:0;">DIAGN√ìSTICO</h2>
        <div class="aviso-teste">
            <i class="fas fa-bug"></i> MODO DE TESTE ATIVADO<br>
            Este login vai ler o banco e te mostrar o que encontrou.
        </div>

        <form onsubmit="fazerLoginDiagnostico(event)">
            <input type="text" id="user" placeholder="Usu√°rio (Ex: admin)" required>
            <input type="password" id="pass" placeholder="Senha (Ex: 1234)" required>
            <button type="submit" class="btn-login" id="btnEntrar">TESTAR CONEX√ÉO</button>
        </form>
    </div>

    <script>
        async function fazerLoginDiagnostico(e) {
            e.preventDefault();
            const btn = document.getElementById('btnEntrar');
            const userDigitado = document.getElementById('user').value.toLowerCase().trim();
            const passDigitado = document.getElementById('pass').value.trim();

            btn.innerText = "INVESTIGANDO...";
            btn.style.opacity = "0.7";

            try {
                // 1. TENTA ACESSAR A COLE√á√ÉO 'equipe'
                // Trazemos tudo para ver o que tem dentro
                const snapshot = await db.collection("equipe").get();

                // CEN√ÅRIO 1: Cole√ß√£o vazia ou nome errado
                if (snapshot.empty) {
                    alert("‚ùå ERRO GRAVE:\n\nA cole√ß√£o 'equipe' n√£o foi encontrada ou est√° vazia!\n\nVerifique se no Firebase o nome da cole√ß√£o √© exatamente: equipe (min√∫sculo, sem acento).");
                    btn.innerText = "FALHA";
                    return;
                }

                // CEN√ÅRIO 2: A cole√ß√£o existe. Vamos ver o que tem dentro.
                let encontrouAlguem = false;
                let relatorio = "üìã RELAT√ìRIO DO BANCO:\n";
                let senhaCertaNoBanco = "";

                snapshot.forEach(doc => {
                    const dados = doc.data();
                    // Lista o que achou
                    relatorio += `\nüë§ Achei: Login='${dados.login}' | Senha='${dados.pass}'`;

                    if (dados.login == userDigitado) {
                        encontrouAlguem = true;
                        senhaCertaNoBanco = dados.pass;
                    }
                });

                if (encontrouAlguem) {
                    // O usu√°rio existe. Vamos ver a senha.
                    if (senhaCertaNoBanco == passDigitado) {
                        alert("‚úÖ SUCESSO TOTAL!\n\nO sistema encontrou o usu√°rio e a senha bateu.\nRedirecionando para o Admin...");
                        
                        // Faz o login de verdade
                        const userDoc = snapshot.docs.find(d => d.data().login == userDigitado).data();
                        localStorage.setItem('usuarioLogado', userDoc.login);
                        localStorage.setItem('cargoUsuario', userDoc.role);
                        window.location.href = 'admin.html';
                    
                    } else {
                        // A senha n√£o bateu (Problema de espa√ßo ou digita√ß√£o)
                        alert(`‚ö†Ô∏è QUASE L√Å!\n\nEncontrei o usu√°rio '${userDigitado}', mas a senha n√£o bateu.\n\nSenha que voc√™ digitou: '${passDigitado}'\nSenha que est√° no Banco: '${senhaCertaNoBanco}'\n\n(Verifique se tem espa√ßos escondidos!)`);
                    }
                } else {
                    // N√£o achou o usu√°rio
                    alert(`‚ùå USU√ÅRIO N√ÉO ENCONTRADO\n\nVoc√™ digitou: '${userDigitado}'\n\nMas no banco eu s√≥ achei estes:\n${relatorio}`);
                }

            } catch (error) {
                console.error(error);
                alert("üö´ ERRO DE CONEX√ÉO:\n\n" + error.message + "\n\nO sistema n√£o conseguiu chegar at√© o Firebase. Verifique o arquivo firebase-config.js");
            } finally {
                btn.innerText = "TESTAR NOVAMENTE";
                btn.style.opacity = "1";
            }
        }
    </script>

</body>
</html>
