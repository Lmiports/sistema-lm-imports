<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√âRTICE BI | CORE</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="logo.png" type="image/png">
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        /* --- PADR√ÉO VISUAL V√âRTICE BI CORE --- */
        :root { 
            --bg: #020617; 
            --card: #0f172a; 
            --accent: #00e0ff; /* AZUL NEON */
            --border: #1e293b; 
            --text: #f8fafc; 
            --success: #10b981; 
            --danger: #ef4444; 
        }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            display: block; 
            min-height: 100vh; 
            overflow-y: auto; 
            user-select: none; /* Evita sele√ß√£o no touch */
        }
        
        /* HEADER FIXO */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        
        /* Bot√£o Menu estilo APP */
        .btn-home {
            background: #1e293b;
            color: #fff;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border);
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .btn-home:hover { background: var(--accent); border-color: var(--accent); color: #000; }

        .page-title { font-size: 18px; font-weight: bold; color: var(--accent); letter-spacing: 1px; margin: 0; }
        .version-tag { font-size: 10px; color: #000; background: var(--accent); padding: 2px 6px; border-radius: 4px; margin-left: 10px; font-weight: 900; letter-spacing: 1px; vertical-align: middle; }

        /* CONTENT */
        .content { 
            padding: 20px; 
            display: grid; 
            grid-template-columns: 1fr 1.5fr; 
            gap: 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; height: fit-content; }
        .card-header { padding: 15px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 14px; font-weight: bold; color: var(--accent); text-transform: uppercase; margin: 0; }

        /* LISTA (ESQUERDA) */
        .search-box { padding: 15px; border-bottom: 1px solid var(--border); }
        .list-container { max-height: 600px; overflow-y: auto; flex: 1; }
        
        .list-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: 0.2s; cursor: pointer; }
        .list-item:hover { background: rgba(0, 224, 255, 0.1); }
        .list-item.active { background: var(--accent); color: #000; }
        .list-item.active .list-meta { color: #000; font-weight: bold; }

        .list-name { font-weight: bold; font-size: 14px; }
        .list-meta { font-size: 11px; color: #94a3b8; margin-top: 3px; display: flex; align-items: center; gap: 5px; }

        /* FORMUL√ÅRIO (DIREITA) */
        .form-body { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .label { font-size: 10px; text-transform: uppercase; color: #64748b; font-weight: bold; margin-bottom: 5px; display: block; }
        
        input, textarea { width: 100%; padding: 12px; background: #020617; border: 1px solid var(--border); border-radius: 8px; color: #fff; outline: none; box-sizing: border-box; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--accent); }
        
        /* BOT√ïES */
        .btn-group { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; background: var(--card); }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-save { background: var(--success); color: #000; }
        .btn-new { background: var(--accent); color: #000; width: 100%; justify-content: center; }
        .btn-del { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        
        /* CEP */
        .cep-wrapper { display: flex; gap: 10px; }
        .btn-search { background: var(--accent); color: #000; border: none; width: 42px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn-search:hover { background: #fff; }

        /* RODAP√â */
        .footer { text-align: center; padding: 20px; color: #64748b; font-size: 11px; border-top: 1px solid var(--border); margin-top: 20px; width: 100%; }

        /* RESPONSIVIDADE MOBILE */
        @media (max-width: 900px) {
            .content { display: flex; flex-direction: column; padding: 10px; }
            .card:first-child { max-height: 350px; flex: none; }
            .list-container { max-height: 250px; }
            .form-grid { grid-template-columns: 1fr !important; }
            .btn { width: 100%; justify-content: center; }
            .btn-group { flex-direction: column-reverse; }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="header-top">
        <div class="header-left">
            <div onclick="window.location.href='menu.html'" class="btn-home"><i class="fas fa-home"></i> MENU</div>
            <h1 class="page-title">V√âRTICE BI <span class="version-tag">CORE</span></h1>
        </div>
        <div></div>
    </div>

    <main class="content">
        
        <section class="card">
            <div class="card-header">
                <h3 class="card-title">Parceiros</h3>
                <span style="font-size:10px; color:#64748b" id="total-items">0 registros</span>
            </div>
            <div class="search-box">
                <input type="text" id="busca" placeholder="üîç Buscar fornecedor..." onkeyup="filtrarLista()">
            </div>
            <div class="list-container" id="listaFornecedores">
                <div style="padding:20px; text-align:center; color:#64748b;">Carregando...</div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border);">
                <button class="btn btn-new" onclick="novoItem()">
                    <i class="fas fa-plus"></i> NOVO FORNECEDOR
                </button>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h3 class="card-title">Ficha Cadastral</h3>
                <input type="hidden" id="itemId">
            </div>
            
            <div class="form-body">
                <div>
                    <label class="label">Raz√£o Social / Nome Fantasia</label>
                    <input type="text" id="nome" placeholder="Ex: Distribuidora Alpha">
                </div>

                <div class="form-grid">
                    <div>
                        <label class="label">CNPJ</label>
                        <input type="text" id="cnpj" placeholder="00.000.000/0000-00">
                    </div>
                    <div>
                        <label class="label">WhatsApp</label>
                        <input type="text" id="whats" placeholder="(11) 99999-9999">
                    </div>
                </div>

                <div class="form-grid" style="grid-template-columns: 1fr 2fr;">
                    <div>
                        <label class="label">CEP</label>
                        <div class="cep-wrapper">
                            <input type="text" id="cep" placeholder="00000-000" maxlength="9">
                            <button class="btn-search" onclick="buscarCEP()"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="label">Endere√ßo (Auto)</label>
                        <input type="text" id="endereco" readonly style="color:#94a3b8; cursor:not-allowed;">
                    </div>
                </div>

                <div class="form-grid">
                    <div>
                        <label class="label">E-mail</label>
                        <input type="email" id="email" placeholder="contato@empresa.com">
                    </div>
                    <div>
                        <label class="label">Instagram</label>
                        <input type="text" id="insta" placeholder="@...">
                    </div>
                </div>

                <div>
                    <label class="label">Hist√≥rico / Observa√ß√µes</label>
                    <textarea id="historico" style="height:100px;" placeholder="Principais produtos, condi√ß√µes de pagamento, etc..."></textarea>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-del" onclick="deletarItem()">
                    <i class="fas fa-trash"></i> Excluir
                </button>
                <button class="btn btn-save" onclick="salvarItem()">
                    <i class="fas fa-save"></i> SALVAR DADOS
                </button>
            </div>
        </section>

        <div class="footer" style="grid-column: 1 / -1;">
            V√âRTICE BI CORE v11.0 ¬© Rodrigo N Carvalho 2026
        </div>

    </main>

    <script>
        // --- üîí KILL SWITCH ---
        const DATA_LIMITE = new Date('2030-01-01'); 
        if(new Date() > DATA_LIMITE) { 
            document.body.innerHTML = '<div style="height:100vh;display:flex;justify-content:center;align-items:center;background:#000;color:red;flex-direction:column;"><h1>ACESSO SUSPENSO</h1><p>Contate o suporte.</p></div>'; 
            throw new Error("Bloqueado"); 
        }

        let dbItens = [];
        let itemSelecionadoId = null;

        // 1. INICIALIZA√á√ÉO
        window.onload = () => {
            const cargo = localStorage.getItem('cargoUsuario');
            if(!cargo) window.location.href='index.html';

            db.collection("fornecedores").orderBy("nome").onSnapshot(snap => {
                dbItens = [];
                snap.forEach(doc => dbItens.push({ id: doc.id, ...doc.data() }));
                document.getElementById('total-items').innerText = `${dbItens.length} registros`;
                renderizarLista(dbItens);
            });
        };

        // 2. LISTAGEM
        function renderizarLista(lista) {
            const div = document.getElementById('listaFornecedores');
            div.innerHTML = "";
            
            lista.forEach(f => {
                const el = document.createElement('div');
                el.className = `list-item ${itemSelecionadoId === f.id ? 'active' : ''}`;
                el.onclick = () => carregarItem(f);
                
                // Bot√£o de Whats flutuante na lista
                let whatsLink = f.whats ? `
                    <a href="https://wa.me/55${f.whats.replace(/\D/g,'')}" target="_blank" onclick="event.stopPropagation()" style="color:${itemSelecionadoId === f.id ? '#000' : 'var(--success)'}">
                        <i class="fab fa-whatsapp"></i>
                    </a>` : '';

                el.innerHTML = `
                    <div>
                        <div class="list-name">${f.nome}</div>
                        <div class="list-meta">
                            ${whatsLink}
                            <span>${f.cnpj || 'Sem CNPJ'}</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right" style="font-size:10px; opacity:0.5;"></i>
                `;
                div.appendChild(el);
            });
        }

        function filtrarLista() {
            const termo = document.getElementById('busca').value.toLowerCase();
            const filtrados = dbItens.filter(i => i.nome.toLowerCase().includes(termo));
            renderizarLista(filtrados);
        }

        // 3. FORMUL√ÅRIO
        function carregarItem(f) {
            itemSelecionadoId = f.id;
            document.getElementById('itemId').value = f.id;
            document.getElementById('nome').value = f.nome || '';
            document.getElementById('cnpj').value = f.cnpj || '';
            document.getElementById('whats').value = f.whats || '';
            document.getElementById('cep').value = f.cep || '';
            document.getElementById('endereco').value = f.endereco || '';
            document.getElementById('email').value = f.email || '';
            document.getElementById('insta').value = f.insta || '';
            document.getElementById('historico').value = f.historico || '';
            
            renderizarLista(dbItens);
            
            if(window.innerWidth <= 900) {
                document.querySelector('.form-body').scrollIntoView({behavior: "smooth"});
            }
        }

        function novoItem() {
            itemSelecionadoId = null;
            document.getElementById('itemId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('nome').focus();
            renderizarLista(dbItens);
            
            if(window.innerWidth <= 900) {
                document.querySelector('.form-body').scrollIntoView({behavior: "smooth"});
            }
        }

        // 4. CEP
        async function buscarCEP() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            if(cep.length !== 8) return;
            
            document.getElementById('endereco').placeholder = "Buscando...";
            const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await res.json();
            
            if(!data.erro) {
                document.getElementById('endereco').value = `${data.logradouro}, ${data.bairro} - ${data.localidade}/${data.uf}`;
            } else {
                alert("CEP n√£o encontrado.");
                document.getElementById('endereco').value = "";
            }
        }

        // 5. CRUD
        async function salvarItem() {
            const id = document.getElementById('itemId').value;
            const dados = {
                nome: document.getElementById('nome').value,
                cnpj: document.getElementById('cnpj').value,
                whats: document.getElementById('whats').value,
                cep: document.getElementById('cep').value,
                endereco: document.getElementById('endereco').value,
                email: document.getElementById('email').value,
                insta: document.getElementById('insta').value,
                historico: document.getElementById('historico').value,
                dataAtualizacao: Date.now()
            };

            if(!dados.nome) return alert("O Nome √© obrigat√≥rio.");

            try {
                if(id) {
                    await db.collection("fornecedores").doc(id).update(dados);
                    alert("Dados atualizados!");
                } else {
                    await db.collection("fornecedores").add(dados);
                    novoItem();
                    alert("Fornecedor cadastrado!");
                }
            } catch (e) { alert("Erro: " + e.message); }
        }

        async function deletarItem() {
            const id = document.getElementById('itemId').value;
            if(!id) return;
            if(confirm("Deseja excluir este fornecedor?")) {
                await db.collection("fornecedores").doc(id).delete();
                novoItem();
            }
        }
    </script>
</body>
</html>
