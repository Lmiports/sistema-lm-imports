<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√âRTICE BI | CORE</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="logo.png" type="image/png">
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        :root {
            --bg: #020617; --card: #0f172a; 
            --accent: #00e0ff; /* AZUL NEON */
            --text: #f8fafc;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; 
            --purple: #8b5cf6; --pink: #ec4899; --gold: #fbbf24; --border: #1e293b;
        }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            display: block; 
            min-height: 100vh; 
            overflow-y: auto; 
            user-select: none;
            padding-bottom: 40px;
        }

        .content { width: 100%; padding: 20px; box-sizing: border-box; }

        .header-title { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; 
        }
        
        .header-title h2 { margin: 0; color: var(--accent); letter-spacing: 2px; text-shadow: 0 0 10px rgba(0,224,255,0.3); }
        .version-tag { font-size: 10px; color: #000; background: var(--accent); padding: 2px 6px; border-radius: 4px; margin-left: 10px; font-weight: 900; letter-spacing: 1px; vertical-align: middle; }

        .btn-voltar-home {
            text-decoration: none; color: #fff; background: rgba(255,255,255,0.1);
            padding: 8px 15px; border-radius: 5px; display: flex; align-items: center; gap: 8px;
            border: 1px solid var(--border); font-size: 14px; transition: 0.3s; cursor: pointer;
        }
        .btn-voltar-home:hover { background: var(--accent); color: #000; font-weight: bold; }

        .action-group { display: flex; gap: 10px; }
        .btn-print { background: var(--accent); color: #000; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; box-shadow: 0 0 10px rgba(0,224,255,0.2); }
        
        .filter-group { display: flex; background: var(--card); padding: 5px; border-radius: 8px; border: 1px solid var(--border); }
        .filter-btn { background: transparent; border: none; color: #94a3b8; padding: 8px 15px; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 12px; }
        .filter-btn.active { background: var(--accent); color: #000; }

        .section-title { font-size: 14px; color: #94a3b8; margin: 30px 0 15px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        
        /* CARDS KPI */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .kpi-card::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent); }
        
        /* Cores das Barras Laterais */
        .kpi-card.green::after { background: var(--success); }
        .kpi-card.red::after { background: var(--danger); }
        .kpi-card.gold::after { background: var(--gold); }
        .kpi-card.purple::after { background: var(--purple); }
        
        .kpi-title { font-size: 11px; color: #94a3b8; text-transform: uppercase; font-weight: 700; }
        .kpi-value { font-size: 22px; font-weight: bold; margin: 10px 0; color: #fff; }
        .kpi-sub { font-size: 11px; opacity: 0.7; }

        /* GR√ÅFICOS */
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: 300px; }

        /* TABELA */
        .table-box { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
        th { text-align: left; color: #94a3b8; padding: 12px; border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }

        .btn-trash {
            background: transparent; border: 1px solid var(--danger); color: var(--danger);
            width: 30px; height: 30px; border-radius: 5px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-trash:hover { background: var(--danger); color: #fff; }

        /* VALUATION BARRA */
        .stock-bar { display: flex; gap: 2px; height: 6px; width: 100%; border-radius: 3px; overflow: hidden; margin: 10px 0; }
        .sb-item { height: 100%; }
        .stock-legend { display: flex; flex-wrap: wrap; gap: 15px; font-size: 11px; color: #94a3b8; }
        .sl-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        /* IMPRESS√ÉO */
        #print-area { display: none; }

        @media print {
            @page { margin: 0; size: A4; }
            .content { display: none !important; }
            #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; padding: 1.5cm; background: #fff; color: #000; }
            /* Estilos b√°sicos de impress√£o omitidos para brevidade, mantendo os originais */
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
            .print-table th, .print-table td { border-bottom: 1px solid #ccc; padding: 5px; text-align: left; }
        }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .header-title { flex-direction: column; align-items: stretch; gap: 15px; }
            .action-group { justify-content: space-between; }
        }
    </style>
</head>
<body>

    <main class="content">
        <div class="header-title">
            <div style="display:flex; align-items:center; gap:15px;">
                <div onclick="window.location.href='menu.html'" class="btn-voltar-home"><i class="fas fa-home"></i> Menu</div>
                <h2>V√âRTICE BI <span class="version-tag">CORE</span></h2>
            </div>
            
            <div class="action-group">
                <div class="filter-group">
                    <button class="filter-btn" onclick="mudarFiltro('semanal', this)">7 Dias</button>
                    <button class="filter-btn active" onclick="mudarFiltro('mensal', this)">M√™s</button>
                    <button class="filter-btn" onclick="mudarFiltro('todos', this)">Geral</button>
                </div>
                <button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> Relat√≥rio</button>
            </div>
        </div>

        <div class="section-title"><i class="fas fa-wallet"></i> Resultados Financeiros (Vendas Reais)</div>
        <div class="kpi-grid">
            <div class="kpi-card green">
                <div class="kpi-title">Faturamento Bruto</div>
                <div class="kpi-value" id="kpi-faturamento">R$ 0,00</div>
                <div class="kpi-sub">Total vendido no per√≠odo</div>
            </div>
            <div class="kpi-card gold">
                <div class="kpi-title">Lucro Estimado</div>
                <div class="kpi-value" id="kpi-lucro" style="color: var(--gold);">R$ 0,00</div>
                <div class="kpi-sub">Faturamento - Custo</div>
            </div>
            <div class="kpi-card purple">
                <div class="kpi-title">Ticket M√©dio</div>
                <div class="kpi-value" id="kpi-ticket">R$ 0,00</div>
                <div class="kpi-sub">Por venda realizada</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Markup M√©dio</div>
                <div class="kpi-value" id="kpi-markup">0%</div>
                <div class="kpi-sub">Margem sobre custo</div>
            </div>
        </div>

        <div class="section-title"><i class="fas fa-cogs"></i> Operacional</div>
        <div class="kpi-grid">
             <div class="kpi-card red">
                <div class="kpi-title">Descontos</div>
                <div class="kpi-value" id="kpi-descontos">R$ 0,00</div>
                <div class="kpi-sub">Negocia√ß√µes</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Brindes</div>
                <div class="kpi-value" id="kpi-brindes">0</div>
                <div class="kpi-sub">Itens bonificados</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Or√ßamentos</div>
                <div class="kpi-value" id="kpi-orcamentos">0</div>
                <div class="kpi-sub">Em aberto</div>
            </div>
             <div class="kpi-card yellow">
                <div class="kpi-title">Trocas (Entrada)</div>
                <div class="kpi-value" id="kpi-trocas">R$ 0,00</div>
                <div class="kpi-sub">Cr√©dito gerado</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-box"><h4 style="margin:0 0 10px 0;">Evolu√ß√£o de Vendas</h4><canvas id="graficoLinha"></canvas></div>
            <div class="chart-box"><h4 style="margin:0 0 10px 0;">Mix de Produtos</h4><canvas id="graficoRosca"></canvas></div>
        </div>

        <div class="section-title"><i class="fas fa-cubes"></i> Valuation de Estoque (Dispon√≠vel)</div>
        <div style="background:var(--card); padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="color:#94a3b8; font-size:12px;">CAPITAL TOTAL EM ESTOQUE</span>
                <strong style="font-size:20px; color:var(--text);" id="val-total">R$ 0,00</strong>
            </div>
            <div class="stock-bar" id="stock-bar">
                </div>
            <div class="stock-legend" id="stock-legend">
                </div>
        </div>

        <div class="table-box">
            <h4 style="margin:0 0 15px 0;">√öltimas Vendas Realizadas (Edi√ß√£o)</h4>
            <table>
                <thead><tr><th>Data</th><th>Cliente</th><th>Itens</th><th>Total</th><th style="text-align:center;">A√ß√£o</th></tr></thead>
                <tbody id="tabela-vendas"><tr><td colspan="5" style="text-align:center; color:#888;">Carregando dados...</td></tr></tbody>
            </table>
        </div>

        <div class="footer">
            V√âRTICE BI CORE v11.1 ¬© Rodrigo N Carvalho 2026
        </div>
    </main>

    <div id="print-area">
        <div class="print-header"><h1>RELAT√ìRIO GERENCIAL - LM IMPORTS</h1></div>
        <p>Data: <span id="print-date"></span></p>
        <h3>Resumo Financeiro</h3>
        <p>Faturamento: <b id="print-fat"></b></p>
        <p>Lucro Estimado: <b id="print-lucro"></b></p>
        <hr>
        <h3>Vendas</h3>
        <table class="print-table">
            <thead><tr><th>Data</th><th>Cliente</th><th>Valor</th></tr></thead>
            <tbody id="print-table-body"></tbody>
        </table>
    </div>

    <script>
        // --- üîí KILL SWITCH ---
        const DATA_LIMITE = new Date('2030-01-01'); 
        if(new Date() > DATA_LIMITE) { throw new Error("Bloqueado"); }

        if(localStorage.getItem('cargoUsuario') !== 'admin') { window.location.href = 'index.html'; }

        let vendasData = [], estoqueData = [], filtroAtual = 'mensal';
        let chartLinhaInstance = null, chartRoscaInstance = null;

        window.onload = function() { 
            document.getElementById('print-date').innerText = new Date().toLocaleString('pt-BR');
            carregarDados(); 
        };

        function limparMoeda(valor) {
            if (typeof valor === 'number') return valor;
            if (!valor) return 0;
            let limpo = valor.toString().replace(/[R$\s]/g, '').trim();
            if (limpo.indexOf(',') > -1 && limpo.indexOf('.') > -1) { limpo = limpo.replace(/\./g, '').replace(',', '.'); }
            else if (limpo.indexOf(',') > -1) { limpo = limpo.replace(',', '.'); }
            return parseFloat(limpo) || 0;
        }
        function formatMoeda(val) { return val.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); }

        async function carregarDados() {
            try {
                const snapVendas = await db.collection("vendas").orderBy("data", "desc").get();
                vendasData = []; snapVendas.forEach(doc => vendasData.push({ id: doc.id, ...doc.data() }));
                
                const snapEstoque = await db.collection("estoque").get();
                estoqueData = []; snapEstoque.forEach(doc => estoqueData.push({ id: doc.id, ...doc.data() }));
                
                calcularValuationEstoque(); 
                aplicarFiltroData();
            } catch (error) { console.error("Erro:", error); }
        }

        // --- EXCLUS√ÉO DE VENDA (NOVO) ---
        function excluirVenda(id) {
            if(confirm("ATEN√á√ÉO: Deseja excluir este registro de venda do hist√≥rico financeiro?\n\nIsso N√ÉO retorna os itens ao estoque (caso j√° tenha feito manualmente).")) {
                db.collection("vendas").doc(id).delete().then(() => {
                    alert("Venda removida do hist√≥rico!");
                    carregarDados(); // Recarrega tudo
                }).catch(e => alert("Erro ao excluir: " + e));
            }
        }

        function mudarFiltro(tipo, btn) {
            filtroAtual = tipo;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            aplicarFiltroData();
        }

        function aplicarFiltroData() {
            const agora = new Date();
            const vendasFiltradas = vendasData.filter(v => {
                try {
                    const dataVenda = new Date(v.data);
                    if (filtroAtual === 'todos') return true;
                    if (filtroAtual === 'semanal') return Math.ceil(Math.abs(agora - dataVenda) / (1000 * 60 * 60 * 24)) <= 7;
                    if (filtroAtual === 'mensal') return dataVenda.getMonth() === agora.getMonth() && dataVenda.getFullYear() === agora.getFullYear();
                } catch(e) { return false; }
            });
            calcularKPIs(vendasFiltradas); 
            renderizarGraficos(vendasFiltradas); 
            renderizarTabela(vendasFiltradas);
        }

        function calcularKPIs(dados) {
            let faturamento = 0, custoTotalVendas = 0, totalDescontos = 0, qtdBrindes = 0, qtdOrcamentos = 0;
            let qtdVendasReais = 0;
            let trocasEntrada = 0;

            dados.forEach(v => {
                // Filtra or√ßamentos
                if (v.status === 'ORCAMENTO' || v.tipoRegistro === 'OR√áAMENTO' || v.status === 'OR√áAMENTO') {
                    qtdOrcamentos++; return; 
                }

                let totalVenda = limparMoeda(v.total);
                faturamento += totalVenda;
                totalDescontos += limparMoeda(v.desconto);
                qtdVendasReais++;

                // CALCULO DO CUSTO (LUCRO)
                if (v.itens) {
                    v.itens.forEach(item => {
                        if (item.isBrinde) qtdBrindes++;
                        // Tenta pegar o custo salvo na venda, se n√£o tiver, assume 0 (margem 100% falsa, mas evita erro)
                        let custoItem = limparMoeda(item.custo || 0); 
                        custoTotalVendas += custoItem;
                    });
                }
                
                // Trocas
                if (v.trocas && Array.isArray(v.trocas)) {
                    v.trocas.forEach(t => trocasEntrada += limparMoeda(t.valor));
                }
            });

            // NOVOS CALCULOS
            let lucroEstimado = faturamento - custoTotalVendas;
            let ticketMedio = qtdVendasReais > 0 ? faturamento / qtdVendasReais : 0;
            let markup = custoTotalVendas > 0 ? (lucroEstimado / custoTotalVendas) * 100 : 0;

            // DOM UPDATE
            document.getElementById('kpi-faturamento').innerText = formatMoeda(faturamento);
            document.getElementById('kpi-lucro').innerText = formatMoeda(lucroEstimado);
            document.getElementById('kpi-ticket').innerText = formatMoeda(ticketMedio);
            document.getElementById('kpi-markup').innerText = markup.toFixed(1) + '%';
            
            document.getElementById('kpi-descontos').innerText = formatMoeda(totalDescontos);
            document.getElementById('kpi-brindes').innerText = qtdBrindes;
            document.getElementById('kpi-orcamentos').innerText = qtdOrcamentos;
            document.getElementById('kpi-trocas').innerText = formatMoeda(trocasEntrada);

            // Print Update
            document.getElementById('print-fat').innerText = formatMoeda(faturamento);
            document.getElementById('print-lucro').innerText = formatMoeda(lucroEstimado);
        }

        function renderizarGraficos(dados) {
            const dadosReais = dados.filter(v => v.status !== 'ORCAMENTO' && v.tipoRegistro !== 'OR√áAMENTO');
            
            // LINHA
            const vendasPorDia = {};
            dadosReais.forEach(v => {
                const dia = new Date(v.data).toLocaleDateString('pt-BR').slice(0,5);
                vendasPorDia[dia] = (vendasPorDia[dia] || 0) + limparMoeda(v.total);
            });
            
            const ctxL = document.getElementById('graficoLinha').getContext('2d');
            if(chartLinhaInstance) chartLinhaInstance.destroy();
            chartLinhaInstance = new Chart(ctxL, {
                type: 'line',
                data: {
                    labels: Object.keys(vendasPorDia).reverse(),
                    datasets: [{
                        label: 'Vendas (R$)', data: Object.values(vendasPorDia).reverse(),
                        borderColor: '#00e0ff', backgroundColor: 'rgba(0, 224, 255, 0.1)', fill: true, tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#94a3b8' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } } } }
            });

            // ROSCA
            let cats = { 'Celular':0, 'Acess√≥rio':0, 'Outros':0 };
            dadosReais.forEach(v => {
                if(v.itens) v.itens.forEach(i => {
                    let nome = (i.modelo || i || '').toString().toLowerCase();
                    if(nome.includes('celular') || nome.includes('iphone') || nome.includes('samsung')) cats['Celular']++;
                    else if(nome.includes('capa') || nome.includes('pel√≠cula') || nome.includes('fone')) cats['Acess√≥rio']++;
                    else cats['Outros']++;
                });
            });

            const ctxR = document.getElementById('graficoRosca').getContext('2d');
            if(chartRoscaInstance) chartRoscaInstance.destroy();
            chartRoscaInstance = new Chart(ctxR, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{
                        data: Object.values(cats),
                        backgroundColor: ['#00e0ff', '#8b5cf6', '#cbd5e1'], borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff' } } } }
            });
        }

        function renderizarTabela(dados) {
            const tbody = document.getElementById('tabela-vendas');
            const pbody = document.getElementById('print-table-body');
            tbody.innerHTML = ""; pbody.innerHTML = "";
            
            const dadosReais = dados.filter(v => v.status !== 'ORCAMENTO' && v.tipoRegistro !== 'OR√áAMENTO');

            dadosReais.slice(0, 20).forEach(v => {
                let itensStr = v.itens ? v.itens.map(i => i.modelo || i).join(", ") : "-";
                let resumo = itensStr.length > 25 ? itensStr.substring(0,25)+"..." : itensStr;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(v.data).toLocaleDateString('pt-BR')}</td>
                        <td style="font-weight:bold; color:#fff;">${v.cliente}</td>
                        <td style="color:#94a3b8;">${resumo}</td>
                        <td style="color:#10b981; font-weight:bold;">${formatMoeda(limparMoeda(v.total))}</td>
                        <td style="text-align:center;">
                            <button class="btn-trash" onclick="excluirVenda('${v.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                pbody.innerHTML += `<tr><td>${new Date(v.data).toLocaleDateString('pt-BR')}</td><td>${v.cliente}</td><td>${formatMoeda(limparMoeda(v.total))}</td></tr>`;
            });
        }

        function calcularValuationEstoque() {
            let total = 0;
            let porCat = {}; 
            
            estoqueData.forEach(p => {
                if(p.status === 'dispon√≠vel') {
                    let val = limparMoeda(p.venda);
                    let cat = (p.categoria || 'Outros').toUpperCase();
                    total += val;
                    porCat[cat] = (porCat[cat] || 0) + val;
                }
            });

            document.getElementById('val-total').innerText = formatMoeda(total);

            // GERA BARRA VISUAL
            const bar = document.getElementById('stock-bar');
            const legend = document.getElementById('stock-legend');
            bar.innerHTML = ''; legend.innerHTML = '';
            
            const cores = ['#00e0ff', '#8b5cf6', '#ec4899', '#fbbf24', '#10b981'];
            let i = 0;

            for (let [cat, valor] of Object.entries(porCat)) {
                let pct = (valor / total) * 100;
                let cor = cores[i % cores.length];
                
                // Barra
                bar.innerHTML += `<div class="sb-item" style="width:${pct}%; background:${cor};" title="${cat}: ${formatMoeda(valor)}"></div>`;
                
                // Legenda
                legend.innerHTML += `<div><span class="sl-dot" style="background:${cor}"></span>${cat} (${Math.round(pct)}%)</div>`;
                i++;
            }
        }
    </script>
</body>
</html>
