<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VÉRTICE BI | CORE</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        :root { 
            --bg: #020617; 
            --card: #0f172a; 
            --accent: #00e0ff; 
            --text: #f8fafc; 
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1); 
            --success: #22c55e; 
            --danger: #ef4444; 
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 20px; 
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* --- HEADER (Estilo App) --- */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid var(--border); 
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        
        .btn-home { 
            background: rgba(255,255,255,0.05); 
            color: var(--accent); 
            text-decoration: none; 
            padding: 10px 15px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            transition: 0.3s; 
            font-weight: bold;
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .btn-home:hover { background: rgba(0, 224, 255, 0.1); border-color: var(--accent); }

        .app-title { font-size: 20px; font-weight: 800; letter-spacing: 1px; color: #fff; margin: 0; }
        .app-title span { color: var(--accent); }

        /* --- CARDS DE KPI (Resumo) --- */
        .kpi-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        .kpi-card { 
            background: var(--card); 
            border: 1px solid var(--border); 
            padding: 20px; 
            border-radius: 12px; 
            position: relative; 
            overflow: hidden;
        }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; 
            background: var(--accent); 
        }
        .kpi-card.green::before { background: var(--success); }
        .kpi-card.red::before { background: var(--danger); }

        .kpi-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .kpi-value { font-size: 24px; font-weight: 800; margin-top: 5px; color: #fff; }
        .kpi-sub { font-size: 10px; color: var(--text-muted); margin-top: 5px; }

        /* --- GRÁFICOS --- */
        .charts-grid { 
            display: grid; 
            grid-template-columns: 2fr 1fr; /* 2/3 para Vendas, 1/3 para Pizza */
            gap: 20px; 
            margin-bottom: 25px;
        }
        
        .chart-box { 
            background: var(--card); 
            border: 1px solid var(--border); 
            padding: 20px; 
            border-radius: 15px; 
            min-height: 300px;
        }
        
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .chart-title { font-weight: bold; color: var(--accent); }

        /* --- TABELA DE VENDAS RECENTES --- */
        .recent-sales { background: var(--card); border: 1px solid var(--border); border-radius: 15px; padding: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; color: var(--text-muted); padding: 10px; border-bottom: 1px solid var(--border); font-size: 11px; text-transform: uppercase; }
        td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #e2e8f0; }
        .status-tag { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; background: rgba(34, 197, 94, 0.2); color: var(--success); }

        /* LOADING */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* RODAPÉ */
        .footer { text-align: center; font-size: 10px; color: rgba(255,255,255,0.2); margin-top: 30px; }

        /* MOBILE */
        @media (max-width: 850px) {
            .charts-grid { grid-template-columns: 1fr; } /* Um gráfico embaixo do outro */
            .kpi-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p style="margin-top:10px; font-size:12px; color:#666;">Carregando BI...</p>
    </div>

    <div class="header">
        <div class="header-left">
            <a href="menu.html" class="btn-home"><i class="fas fa-home"></i> MENU</a>
            <h1 class="app-title">VÉRTICE <span>BI CORE</span></h1>
        </div>
        <div>
            <span style="font-size:12px; color:#666;">Hoje: <span id="data-hoje"></span></span>
        </div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card green">
            <div class="kpi-label">Faturamento Total</div>
            <div class="kpi-value" id="kpi-faturamento">R$ 0,00</div>
            <div class="kpi-sub">Vendas Concretizadas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Vendas Realizadas</div>
            <div class="kpi-value" id="kpi-qtd">0</div>
            <div class="kpi-sub">Pedidos Fechados</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Ticket Médio</div>
            <div class="kpi-value" id="kpi-ticket">R$ 0,00</div>
            <div class="kpi-sub">Por Venda</div>
        </div>
        <div class="kpi-card red">
            <div class="kpi-label">Orçamentos</div>
            <div class="kpi-value" id="kpi-orcamentos">0</div>
            <div class="kpi-sub" style="color:var(--warning);">Não Convertidos</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-box">
            <div class="chart-header">
                <span class="chart-title">Desempenho de Vendas (7 Dias)</span>
                <i class="fas fa-chart-line" style="color:var(--text-muted)"></i>
            </div>
            <canvas id="chartVendas"></canvas>
        </div>
        <div class="chart-box">
            <div class="chart-header">
                <span class="chart-title">Formas de Pagamento</span>
                <i class="fas fa-chart-pie" style="color:var(--text-muted)"></i>
            </div>
            <canvas id="chartPagamento"></canvas>
        </div>
    </div>

    <div class="recent-sales">
        <h3 style="color:var(--accent); margin-top:0; font-size:14px;">Últimas Vendas Concretizadas</h3>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cliente</th>
                    <th>Itens</th>
                    <th>Valor</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="lista-recentes">
                </tbody>
        </table>
    </div>

    <div class="footer">VÉRTICE BI CORE v11.0 • Rodrigo N Carvalho 2026</div>

    <script>
        // --- CONFIGURAÇÃO INICIAL ---
        const DATA_HOJE = new Date().toLocaleDateString('pt-BR');
        document.getElementById('data-hoje').innerText = DATA_HOJE;

        // --- LÓGICA BI ---
        window.onload = function() {
            // Verifica Login (Segurança Básica)
            const cargo = localStorage.getItem('cargoUsuario');
            if(cargo !== 'admin') {
                alert("Acesso restrito a gestores.");
                window.location.href = 'index.html';
                return;
            }

            carregarDados();
        };

        async function carregarDados() {
            try {
                const snapshot = await db.collection("vendas").orderBy("data", "desc").get();
                
                let totalFat = 0;
                let qtdVendas = 0;
                let qtdOrcamentos = 0;
                let pagamentos = {};
                let vendasPorDia = {};
                const listaRecentes = document.getElementById('lista-recentes');
                listaRecentes.innerHTML = "";

                snapshot.forEach(doc => {
                    const v = doc.data();
                    const valor = parseFloat(v.total) || 0;
                    
                    // --- O FILTRO DE OURO ---
                    // Se tiver status 'ORCAMENTO' ou 'ORÇAMENTO', IGNORA na soma
                    // Se não tiver status (legado), considera venda.
                    if (v.status === 'ORCAMENTO' || v.tipoRegistro === 'ORÇAMENTO') {
                        qtdOrcamentos++;
                        return; // Pula para o próximo, não soma faturamento
                    }

                    // Se passou daqui, é venda válida
                    totalFat += valor;
                    qtdVendas++;

                    // Agrupar Pagamento
                    const pg = v.pagamento ? v.pagamento.split(" ")[0] : "Outros"; // Pega só 'Crédito', 'Pix'...
                    pagamentos[pg] = (pagamentos[pg] || 0) + 1;

                    // Agrupar Por Dia (Para o gráfico)
                    const dataVenda = new Date(v.data).toLocaleDateString('pt-BR').substring(0, 5); // dd/mm
                    vendasPorDia[dataVenda] = (vendasPorDia[dataVenda] || 0) + valor;

                    // Preencher Tabela (Só as 5 últimas)
                    if (qtdVendas <= 5) {
                        const itensStr = v.itens ? v.itens.map(i => i.modelo || i.nome).join(", ") : "-";
                        listaRecentes.innerHTML += `
                            <tr>
                                <td>${new Date(v.data).toLocaleDateString('pt-BR')}</td>
                                <td>${v.cliente}</td>
                                <td style="font-size:10px; color:#aaa;">${itensStr.substring(0,30)}...</td>
                                <td style="color:#22c55e; font-weight:bold;">${valor.toLocaleString('pt-br',{style:'currency', currency:'BRL'})}</td>
                                <td><span class="status-tag">VENDIDO</span></td>
                            </tr>
                        `;
                    }
                });

                // Atualiza KPIs
                document.getElementById('kpi-faturamento').innerText = totalFat.toLocaleString('pt-br',{style:'currency', currency:'BRL'});
                document.getElementById('kpi-qtd').innerText = qtdVendas;
                document.getElementById('kpi-orcamentos').innerText = qtdOrcamentos;
                
                const ticket = qtdVendas > 0 ? (totalFat / qtdVendas) : 0;
                document.getElementById('kpi-ticket').innerText = ticket.toLocaleString('pt-br',{style:'currency', currency:'BRL'});

                // Renderiza Gráficos
                renderChartLinha(vendasPorDia);
                renderChartPizza(pagamentos);

                // Tira Loading
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error(error);
                alert("Erro ao carregar dados do BI.");
            }
        }

        // --- GRÁFICOS (Chart.js) ---
        function renderChartLinha(dadosDia) {
            const ctx = document.getElementById('chartVendas').getContext('2d');
            // Ordenar datas (opcional, básico aqui)
            const labels = Object.keys(dadosDia).reverse(); // Inverte para ficar cronológico se veio desc
            const values = Object.values(dadosDia).reverse();

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: values,
                        borderColor: '#00e0ff',
                        backgroundColor: 'rgba(0, 224, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function renderChartPizza(dadosPgto) {
            const ctx = document.getElementById('chartPagamento').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dadosPgto),
                    datasets: [{
                        data: Object.values(dadosPgto),
                        backgroundColor: ['#22c55e', '#eab308', '#00e0ff', '#ef4444', '#a855f7'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right', labels: { color: '#fff', font: { size: 10 } } } 
                    }
                }
            });
        }
    </script>
</body>
</html>
