<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VÉRTICE - ADMINISTRAÇÃO PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #3b82f6; --border: #1e293b; --text: #f8fafc; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* BLOQUEIO */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: var(--card); padding: 40px; border: 1px solid var(--accent); border-radius: 12px; text-align: center; width: 300px; }
        .login-input { width: 100%; padding: 15px; background: #000; border: 1px solid #333; color: #fff; font-size: 18px; text-align: center; margin-bottom: 20px; border-radius: 8px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 15px; background: var(--accent); color: #fff; border: none; font-weight: bold; border-radius: 8px; cursor: pointer; }

        /* LAYOUT */
        .sidebar { width: 250px; background: #000; border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; transition: 0.3s; }
        .nav-item { padding: 15px; color: #64748b; text-decoration: none; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .nav-item:hover { background: var(--accent); color: #fff; }
        .nav-item.active { background: var(--accent); color: #fff; }

        .content { flex: 1; padding: 30px; overflow-y: auto; display: none; }

        /* KPIS */
        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px; }
        .kpi-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); position: relative; overflow: hidden; min-width: 140px; }
        .kpi-title { font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-value { font-size: 22px; font-weight: bold; margin-top: 10px; color: #fff; }
        .kpi-sub { font-size: 10px; margin-top: 5px; opacity: 0.7; }
        .kpi-icon { position: absolute; right: 15px; top: 15px; font-size: 30px; opacity: 0.1; }

        /* TABS */
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .f-tab { padding: 8px 16px; background: #1e293b; border: 1px solid var(--border); border-radius: 20px; font-size: 12px; cursor: pointer; color: #94a3b8; white-space: nowrap; }
        .f-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

        .dashboard-row { display: grid; grid-template-columns: 2fr 1.2fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
        
        .filter-bar { background: #1e293b; padding: 10px; border-radius: 8px; display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .date-input { background: #000; border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; }
        .btn-filter { background: var(--accent); color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; color: #64748b; font-size: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border); padding: 8px; }
        td { padding: 10px 8px; border-bottom: 1px solid var(--border); font-size: 12px; color: #cbd5e1; }
        .badge-troca { background: rgba(245, 158, 11, 0.2); color: var(--warning); padding: 2px 6px; border-radius: 4px; font-size: 9px; border: 1px solid var(--warning); }

        /* MENU MOBILE ICON */
        .menu-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; background: var(--accent); color: white; border: none; padding: 8px; border-radius: 5px; }

        /* --- RESPONSIVIDADE MOBILE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; height: auto; padding-top: 50px; }
            
            .menu-toggle { display: block; }
            .sidebar { 
                position: fixed; top: 0; left: -250px; height: 100vh; z-index: 1000; 
                background: rgba(0,0,0,0.95); width: 250px; 
            }
            .sidebar.active { left: 0; }

            .content { padding: 15px; overflow: visible; height: auto; }

            /* KPIs em Carrossel */
            .kpi-grid { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 10px; }
            .kpi-card { min-width: 160px; flex: none; }

            /* Dashboard em Pilha */
            .dashboard-row { grid-template-columns: 1fr; gap: 15px; }

            /* Tabelas Roláveis */
            .panel { padding: 15px; overflow-x: auto; }
            
            /* Filtros */
            .filter-bar { flex-direction: column; align-items: stretch; }
            .date-input, .btn-filter { width: 100%; box-sizing: border-box; }
            
            .login-box { width: 90%; }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('active')">
        <i class="fas fa-bars"></i>
    </button>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--accent); margin-bottom:20px;">VÉRTICE ADMIN</h2>
            <input type="password" id="admin-pass" class="login-input" placeholder="Senha Mestra">
            <button class="login-btn" onclick="verificarSenha()">ENTRAR</button>
            <p id="msg-error" style="color:var(--danger); font-size:12px; margin-top:10px; display:none;">Acesso Negado</p>
            <div style="margin-top:20px; font-size:11px; color:#64748b; opacity:0.6;">
                Em caso de perda de acesso, contate o suporte técnico.
            </div>
        </div>
    </div>

    <aside class="sidebar">
        <h2 style="color:var(--accent); text-align:center; margin-bottom:30px; letter-spacing:2px;">VÉRTICE</h2>
        <nav>
            <a href="index.html" class="nav-item"><i class="fas fa-home"></i> Início</a>
            <a href="admin.html" class="nav-item active"><i class="fas fa-chart-pie"></i> Painel Financeiro</a>
        </nav>
    </aside>

    <main class="content" id="app-content">
        <header style="margin-bottom:20px;">
            <h1 style="font-size:20px; margin:0;">Painel Financeiro</h1>
            <p style="color:#64748b; font-size:12px;">Visão gerencial em tempo real.</p>
        </header>

        <div class="filter-tabs">
            <div class="f-tab active" onclick="filtrarKPIs('todos', this)">Todos</div>
            <div class="f-tab" onclick="filtrarKPIs('celular', this)">Celulares</div>
            <div class="f-tab" onclick="filtrarKPIs('roupa', this)">Roupas</div>
            <div class="f-tab" onclick="filtrarKPIs('perfume', this)">Perfumes</div>
            <div class="f-tab" onclick="filtrarKPIs('acessorio', this)">Acessórios</div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">Qtd. Itens</div>
                <div class="kpi-value" id="kpi-qtd">0</div>
                <i class="fas fa-cubes kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color: var(--danger);">
                <div class="kpi-title" style="color:var(--danger);">Custo Estoque</div>
                <div class="kpi-value" id="kpi-custo" style="color:var(--danger);">R$ 0,00</div>
                <i class="fas fa-wallet kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color: var(--accent);">
                <div class="kpi-title" style="color:var(--accent);">Venda Estimada</div>
                <div class="kpi-value" id="kpi-venda" style="color:var(--accent);">R$ 0,00</div>
                <i class="fas fa-tag kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color: var(--success);">
                <div class="kpi-title" style="color:var(--success);">Lucro Projetado</div>
                <div class="kpi-value" id="kpi-lucro" style="color:var(--success);">R$ 0,00</div>
                <i class="fas fa-chart-line kpi-icon"></i>
            </div>
            <div class="kpi-card" style="border-color: var(--warning);">
                <div class="kpi-title" style="color:var(--warning);">Margem %</div>
                <div class="kpi-value" id="kpi-margem" style="color:var(--warning);">0%</div>
                <i class="fas fa-percentage kpi-icon"></i>
            </div>
        </div>

        <div class="dashboard-row">
            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; font-size:14px; color:var(--success)">Histórico de Vendas</h3>
                    <h3 id="total-periodo" style="margin:0; font-size:16px; color:var(--success)">R$ 0,00</h3>
                </div>
                
                <div class="filter-bar">
                    <input type="date" id="dataInicio" class="date-input">
                    <span style="font-size:10px; color:#64748b; text-align:center;">ATÉ</span>
                    <input type="date" id="dataFim" class="date-input">
                    <button class="btn-filter" onclick="carregarVendasFiltradas()">FILTRAR</button>
                </div>

                <div style="flex:1; overflow-y:auto; max-height:400px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Pagamento</th>
                                <th style="text-align:right;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="lista-vendas"></tbody>
                    </table>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="panel">
                    <h3 style="margin:0 0 10px 0; font-size:12px; color:#94a3b8;">DIVISÃO POR CATEGORIA</h3>
                    <div style="height:180px; position:relative;">
                        <canvas id="graficoEstoque"></canvas>
                    </div>
                </div>

                <div class="panel" style="flex:1;">
                    <h3 style="margin:0 0 10px 0; font-size:12px; color:var(--warning);">ENTRADAS (TROCAS)</h3>
                    <div style="overflow-y:auto; max-height:300px;">
                        <table>
                            <tbody id="lista-trocas"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- FUNÇÃO AUXILIAR PARA LIMPAR NÚMEROS (RESOLVE O ERRO DOS NÚMEROS MALUCOS) ---
        function safeNumber(val) {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            // Remove R$, espaços e troca vírgula por ponto
            let str = String(val).replace(/[R$\s]/g, '').replace(',', '.');
            return parseFloat(str) || 0;
        }

        // SENHA SEGURA
        async function verificarSenha() {
            const input = document.getElementById('admin-pass').value;
            try {
                const doc = await db.collection("configuracoes").doc("acesso").get();
                let senhaReal = doc.exists && doc.data().senhaAdmin ? doc.data().senhaAdmin : "1234";
                
                if(input === senhaReal) {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-content').style.display = 'block';
                    iniciar();
                } else {
                    throw new Error("Senha errada");
                }
            } catch(e) {
                document.getElementById('msg-error').style.display = 'block';
            }
        }
        
        document.getElementById('admin-pass').addEventListener('keypress', (e) => { if(e.key === 'Enter') verificarSenha(); });

        let estoqueGlobal = [];
        let chartInstance = null;

        function iniciar() {
            const hoje = new Date();
            const inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            document.getElementById('dataInicio').valueAsDate = inicio;
            document.getElementById('dataFim').valueAsDate = hoje;

            carregarEstoqueEGráfico();
            carregarVendasFiltradas();
            carregarTrocas();
        }

        // 1. CARREGAR ESTOQUE E ATUALIZAR KPIs
        function carregarEstoqueEGráfico() {
            db.collection("estoque").onSnapshot(snap => {
                estoqueGlobal = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.status === 'disponível' || !d.status) {
                        estoqueGlobal.push(d);
                    }
                });
                filtrarKPIs('todos', document.querySelector('.f-tab.active'));
                atualizarGrafico();
            });
        }

        function filtrarKPIs(categoria, el) {
            if(el) {
                document.querySelectorAll('.f-tab').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
            }

            let filtrados = estoqueGlobal;
            if(categoria !== 'todos') {
                filtrados = estoqueGlobal.filter(p => (p.categoria || '').toLowerCase().includes(categoria));
            }

            let qtd = 0, custo = 0, venda = 0;
            filtrados.forEach(p => {
                qtd++;
                custo += safeNumber(p.custo); // Usando safeNumber
                venda += safeNumber(p.venda); // Usando safeNumber
            });

            const lucro = venda - custo;
            const margem = venda > 0 ? ((lucro / venda) * 100) : 0;

            document.getElementById('kpi-qtd').innerText = qtd;
            document.getElementById('kpi-custo').innerText = custo.toLocaleString('pt-br',{style:'currency', currency:'BRL'});
            document.getElementById('kpi-venda').innerText = venda.toLocaleString('pt-br',{style:'currency', currency:'BRL'});
            document.getElementById('kpi-lucro').innerText = lucro.toLocaleString('pt-br',{style:'currency', currency:'BRL'});
            document.getElementById('kpi-margem').innerText = margem.toFixed(1) + "%";
        }

        // 2. HISTÓRICO DE VENDAS (COM CORREÇÃO DE NÚMEROS)
        async function carregarVendasFiltradas() {
            const valIni = document.getElementById('dataInicio').value;
            const valFim = document.getElementById('dataFim').value;
            
            if(!valIni || !valFim) return;

            const ini = new Date(valIni + "T00:00:00").getTime();
            const fim = new Date(valFim + "T23:59:59").getTime();

            const snap = await db.collection("vendas").orderBy("data", "desc").get();

            let html = "";
            let totalPeriodo = 0;

            snap.forEach(doc => {
                const v = doc.data();
                if(v.data >= ini && v.data <= fim) {
                    
                    // Limpeza do valor total
                    let valorReal = safeNumber(v.total);
                    totalPeriodo += valorReal;
                    
                    const d = new Date(v.data);
                    
                    let corValor = 'var(--success)';
                    let txtTotal = `R$ ${valorReal.toFixed(2)}`;
                    
                    if(valorReal < 0) {
                        corValor = 'var(--warning)';
                        txtTotal = `(TROCO) R$ ${Math.abs(valorReal).toFixed(2)}`;
                    }

                    html += `<tr>
                        <td>${d.toLocaleDateString('pt-BR')} <br><small style="opacity:0.5">${d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</small></td>
                        <td><strong>${v.clienteNome || 'Consumidor'}</strong></td>
                        <td><span style="font-size:10px; opacity:0.7">${v.formaPagamento || '-'}</span></td>
                        <td style="text-align:right; color:${corValor}; font-weight:bold;">${txtTotal}</td>
                    </tr>`;
                }
            });

            document.getElementById('lista-vendas').innerHTML = html || '<tr><td colspan="4" style="text-align:center;">Nenhuma venda no período.</td></tr>';
            document.getElementById('total-periodo').innerText = totalPeriodo.toLocaleString('pt-br',{style:'currency', currency:'BRL'});
        }

        // 3. CARREGAR TODAS AS TROCAS
        function carregarTrocas() {
            db.collection("estoque").orderBy("dataEntrada", "desc").limit(20).onSnapshot(snap => {
                let html = "";
                snap.forEach(doc => {
                    const t = doc.data();
                    if(t.observacao && t.observacao.toLowerCase().includes("troca")) {
                        const d = t.dataEntrada ? new Date(t.dataEntrada).toLocaleDateString('pt-BR') : '-';
                        html += `<tr>
                            <td style="padding:12px 8px;">
                                <div style="font-weight:bold;">${t.modelo}</div>
                                <div style="font-size:10px; color:#64748b;">${t.cor || ''} ${t.gb || ''}</div>
                            </td>
                            <td style="text-align:center;"><span class="badge-troca">TROCA</span><br><small style="font-size:9px;">${d}</small></td>
                            <td style="text-align:right; font-weight:bold; color:var(--warning);">R$ ${safeNumber(t.custo).toFixed(2)}</td>
                        </tr>`;
                    }
                });
                document.getElementById('lista-trocas').innerHTML = html || '<tr><td colspan="3" style="text-align:center; padding:20px;">Nenhuma troca recente.</td></tr>';
            });
        }

        // 4. GRÁFICO
        function atualizarGrafico() {
            const ctx = document.getElementById('graficoEstoque').getContext('2d');
            let dados = { 'celular': 0, 'acessorio': 0, 'roupa': 0, 'perfume': 0, 'outros': 0 };
            
            estoqueGlobal.forEach(p => {
                const cat = (p.categoria || 'outros').toLowerCase();
                const val = safeNumber(p.venda); // Usando safeNumber
                
                if(cat.includes('celular')) dados['celular'] += val;
                else if(cat.includes('acessorio')) dados['acessorio'] += val;
                else if(cat.includes('roupa')) dados['roupa'] += val;
                else if(cat.includes('perfume')) dados['perfume'] += val;
                else dados['outros'] += val;
            });

            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cel', 'Acess.', 'Roupa', 'Perf.', 'Outros'],
                    datasets: [{
                        data: [dados.celular, dados.acessorio, dados.roupa, dados.perfume, dados.outros],
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff', boxWidth: 10, font: {size: 10} } } }
                }
            });
        }
    </script>
</body>
</html>