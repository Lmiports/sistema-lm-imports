<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VÃ‰RTICE BI | CORE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #00e0ff; --text: #f8fafc; --border: rgba(255, 255, 255, 0.1); --success: #22c55e; --danger: #ef4444; --warning: #eab308; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .header h2 { margin: 0; color: var(--accent); letter-spacing: 2px; }
        .version-tag { font-size: 10px; background: var(--accent); color: #000; padding: 2px 6px; border-radius: 4px; font-weight: 900; margin-left: 10px; }
        .btn-voltar { color: #fff; text-decoration: none; font-size: 20px; padding: 10px; transition: 0.3s; }
        .btn-voltar:hover { color: var(--accent); }
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; flex: 1; }
        .products-section { display: flex; flex-direction: column; gap: 15px; }
        .search-box { display: flex; gap: 10px; }
        .search-box input, .search-box select { width: 100%; padding: 12px; background: var(--card); border: 1px solid var(--border); color: #fff; border-radius: 8px; outline: none; }
        .products-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; max-height: 75vh; overflow-y: auto; }
        .product-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 15px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; }
        .product-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .product-card.reserved { opacity: 0.6; border-color: var(--warning); filter: grayscale(0.5); pointer-events: none; }
        .prod-cat-tag { font-size: 10px; background: rgba(0,224,255,0.1); color: var(--accent); padding: 4px 8px; border-radius: 4px; width: fit-content; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .prod-name { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .prod-detail { font-size: 11px; color: #94a3b8; margin-bottom: 5px; }
        .prod-price { color: var(--success); font-weight: bold; font-size: 16px; margin-top: auto; }
        .cart-section { background: var(--card); border-radius: 15px; border: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; height: fit-content; }
        .client-area { margin-bottom: 15px; }
        .client-row { display: flex; gap: 5px; }
        .client-input-wrapper { width: 100%; }
        .client-row input { width: 100%; padding: 10px; background: #1e293b; border: 1px solid var(--border); color: #fff; border-radius: 5px; box-sizing: border-box; }
        .btn-add-client { background: var(--success); color: #000; border: none; width: 40px; border-radius: 5px; cursor: pointer; font-size: 18px; }
        .cart-items { max-height: 300px; overflow-y: auto; margin-bottom: 15px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 10px 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .cart-item.brinde { border: 1px solid var(--accent); background: rgba(0, 224, 255, 0.1); }
        .item-actions { display: flex; gap: 10px; align-items: center; }
        .btn-icon { cursor: pointer; padding: 5px; }
        .btn-remove { color: var(--danger); }
        .btn-gift { color: #94a3b8; }
        .btn-gift.active { color: var(--accent); text-shadow: 0 0 5px var(--accent); }
        .trade-in-box { background: rgba(234, 179, 8, 0.1); border: 1px solid var(--warning); padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .totals { margin-bottom: 15px; font-size: 14px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .total-final { font-size: 24px; font-weight: 900; color: var(--success); border-top: 1px solid var(--border); padding-top: 10px; }
        .input-desconto { width: 100px; padding: 5px; text-align: right; background: #0f172a; border: 1px solid #334155; color: var(--danger); font-weight: bold; }
        .parcela-info { text-align: right; color: var(--accent); font-size: 12px; font-weight: bold; display: none; padding-bottom: 5px; border-bottom: 1px dashed var(--accent); }
        .action-buttons-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-vender { background: var(--success); color: #000; padding: 15px; width: 100%; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-orcamento { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-troca { background: transparent; border: 1px solid var(--warning); color: var(--warning); padding: 10px; width: 100%; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .btn-limpar { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 5px; width: 100%; border-radius: 5px; margin-bottom: 10px; cursor: pointer; font-size: 11px; }
        .btn-simular { background: #334155; color: #fff; border: 1px solid var(--border); width: 100%; padding: 8px; border-radius: 5px; margin-bottom: 10px; cursor: pointer; }
        .btn-preview { width:100%; background:transparent; border:1px solid #666; color:#aaa; padding:5px; border-radius:5px; cursor:pointer; font-size:11px; margin-bottom:10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: var(--card); padding: 25px; border-radius: 15px; width: 400px; max-width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--accent); }
        .modal input, .modal select { width: 100%; padding: 10px; margin: 5px 0; background: #1e293b; border: 1px solid var(--border); color: #fff; border-radius: 5px; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-cancel { flex: 1; padding: 10px; background: #334155; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        .btn-confirm { flex: 1; padding: 10px; background: var(--success); color: #000; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-dashboard-link { display: none; text-decoration: none; background: var(--accent); color: #000; padding: 5px 15px; border-radius: 5px; font-weight: bold; font-size: 12px; align-items: center; gap: 5px; }
        .marca-registrada { position: fixed; bottom: 5px; right: 10px; font-size: 10px; color: rgba(255, 255, 255, 0.2); pointer-events: none; z-index: 999; }
        @media (max-width: 800px) { .main-grid { grid-template-columns: 1fr; display: flex; flex-direction: column; } .products-list { max-height: 300px; } .cart-section { margin-top: 20px; margin-bottom: 50px; } body { height: auto; display: block; } }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; gap:15px; align-items:center;">
            <a href="#" id="btn-voltar-main" class="btn-voltar" title="Voltar"><i class="fas fa-home"></i></a>
            <a href="admin.html" id="btn-bi-admin" class="btn-dashboard-link"><i class="fas fa-chart-pie"></i> PAINEL BI</a>
        </div>
        <h2>VÃ‰RTICE BI <span class="version-tag">CORE</span></h2>
        <div></div>
    </div>

    <div class="main-grid">
        <div class="products-section">
            <div class="search-box">
                <input type="text" id="busca" placeholder="Buscar..." onkeyup="filtrarProdutos()">
                <select id="filtro-cat" onchange="filtrarProdutos()" style="width: 150px;">
                    <option value="">Todas</option>
                    <option value="celular">ðŸ“± Celulares</option>
                    <option value="roupa">ðŸ‘• Roupas</option>
                    <option value="perfume">ðŸŒ¸ Perfumes</option>
                    <option value="acessorio">ðŸŽ§ AcessÃ³rios</option>
                </select>
            </div>
            <div class="products-list" id="lista-produtos">
                <div style="padding:20px; text-align:center; color:#888;"><i class="fas fa-circle-notch fa-spin"></i> Carregando...</div>
            </div>
        </div>

        <div class="cart-section">
            <div class="client-area">
                <label style="font-size: 12px; color: #94a3b8;">Cliente:</label>
                <div class="client-row">
                    <div class="client-input-wrapper">
                        <input list="lista-clientes-db" id="cliente-input" placeholder="Buscar..." autocomplete="off" onchange="salvarRascunho()">
                        <datalist id="lista-clientes-db"></datalist>
                    </div>
                    <button class="btn-add-client" onclick="document.getElementById('modal-cliente').style.display='flex'">+</button>
                </div>
            </div>

            <div class="cart-items" id="carrinho-lista"><div style="text-align: center; color: #64748b; margin-top: 20px;">Carrinho vazio</div></div>
            <button class="btn-limpar" onclick="cancelarVendaTotal()"><i class="fas fa-trash-alt"></i> LIMPAR TELA / DESTRAVAR</button>
            <div id="lista-trocas"></div>

            <div class="totals">
                <div class="row"><span>Subtotal:</span><span id="valor-subtotal">R$ 0,00</span></div>
                <div class="row" style="color: var(--danger);"><span>Desconto (R$):</span><input type="number" class="input-desconto" id="valor-desconto-manual" value="" placeholder="0,00" oninput="atualizarTotais()"></div>
                <div class="row" style="color: var(--accent); display:none;" id="row-taxas"><span>Taxa Maquininha:</span><span id="valor-taxas">+ R$ 0,00</span></div>
                <div class="row" style="color: var(--warning);"><span>Troca/Abatimento:</span><span id="valor-abatimento">- R$ 0,00</span></div>
                <div class="row total-final"><span>TOTAL:</span><span id="valor-total">R$ 0,00</span></div>
                <div id="detalhe-parcelas" class="parcela-info"></div>
            </div>

            <button class="btn-simular" onclick="abrirSimulador()"><i class="fas fa-calculator"></i> Simular Parcelas</button>
            <div style="margin-bottom: 10px;"><label style="font-size: 12px;">Pagamento:</label><select id="forma-pagamento" style="width: 100%; padding: 8px; background: #1e293b; color: #fff; border: 1px solid var(--border); border-radius: 5px;" onchange="salvarRascunho()"></select></div>
            <button class="btn-troca" onclick="document.getElementById('modal-troca').style.display='flex'"><i class="fas fa-exchange-alt"></i> Entrada de Troca</button>
            <button class="btn-preview" onclick="preVisualizar()"><i class="fas fa-eye"></i> Visualizar Recibo (Sem Salvar)</button>

            <div class="action-buttons-grid">
                <button class="btn-orcamento" onclick="finalizar(true)">ORÃ‡AMENTO</button>
                <button class="btn-vender" onclick="finalizar(false)">VENDER</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-simulador"><div class="modal"><div style="display:flex; justify-content:space-between;"><h3>SimulaÃ§Ã£o</h3><div><button onclick="toggleTaxasVisuais()" style="background:none;border:none;color:#fff;font-size:18px;margin-right:10px;"><i class="fas fa-eye" id="icon-eye"></i></button><button onclick="abrirConfigTaxas()" style="background:none;border:none;color:var(--accent);font-size:18px;"><i class="fas fa-cog"></i></button></div></div><table class="sim-table"><thead><tr><th>Parc.</th><th>Valor</th><th>Total</th></tr></thead><tbody id="lista-simulacao"></tbody></table><button onclick="copiarOfertaZap()" style="margin-top:15px;width:100%;background:#25D366;color:#fff;padding:10px;border:none;border-radius:5px;font-weight:bold;">Copiar</button><button onclick="document.getElementById('modal-simulador').style.display='none'" class="btn-cancel" style="margin-top:5px;width:100%;">Fechar</button></div></div>
    <div class="modal-overlay" id="modal-config-taxas"><div class="modal"><h3>Configurar Taxas</h3><div class="taxas-grid" id="grid-inputs-taxas"></div><div style="display:flex;gap:10px;margin-top:20px;"><button onclick="document.getElementById('modal-config-taxas').style.display='none'" class="btn-cancel">Cancelar</button><button onclick="salvarConfigTaxas()" class="btn-confirm">Salvar</button></div></div></div>
    <div class="modal-overlay" id="modal-troca"><div class="modal" style="border-color:var(--warning);"><h3 style="color:var(--warning);">Troca</h3><label style="font-size:11px;color:#999;">Modelo:</label><input list="dl-modelos-list" id="troca-modelo"><datalist id="dl-modelos-list"></datalist><div class="modal-grid"><div><label style="font-size:11px;color:#999;">GB:</label><select id="troca-gb"><option value="">-</option><option value="64GB">64GB</option><option value="128GB">128GB</option><option value="256GB">256GB</option><option value="512GB">512GB</option></select></div><div><label style="font-size:11px;color:#999;">Cor:</label><input list="dl-cores-list" id="troca-cor"><datalist id="dl-cores-list"></datalist></div></div><label style="font-size:11px;color:#999;">IMEI:</label><input type="text" id="troca-imei" maxlength="15"><div class="modal-grid"><div><label style="font-size:11px;color:#999;">Valor:</label><input type="number" id="troca-valor"></div><div><label style="font-size:11px;color:#999;">Bat %:</label><input type="number" id="troca-bateria"></div></div><div style="display:flex;gap:10px;margin-top:10px;"><button onclick="document.getElementById('modal-troca').style.display='none'" class="btn-cancel">Cancelar</button><button onclick="confirmarTroca()" class="btn-confirm" style="background:var(--warning);">Confirmar</button></div></div></div>
    <div class="modal-overlay" id="modal-cliente"><div class="modal"><h3>Novo Cliente</h3><input type="text" id="novo-nome" placeholder="Nome"><div class="modal-grid"><input type="text" id="novo-zap" placeholder="Zap"><input type="text" id="novo-cpf" placeholder="CPF"></div><input type="email" id="novo-email" placeholder="Email"><div class="modal-grid"><input type="text" id="novo-cep" placeholder="CEP" onblur="buscarCep()"><input type="text" id="novo-numero" placeholder="NÂº"></div><input type="text" id="novo-endereco" placeholder="EndereÃ§o"><div class="modal-grid"><input type="text" id="novo-bairro" placeholder="Bairro"><input type="text" id="novo-cidade" placeholder="Cidade"></div><div style="display:flex;gap:10px;margin-top:20px;"><button onclick="document.getElementById('modal-cliente').style.display='none'" class="btn-cancel">Cancelar</button><button onclick="salvarNovoCliente()" class="btn-confirm">Salvar</button></div></div></div>
    
    <div class="marca-registrada">VÃ‰RTICE BI CORE v11.0 Â© Rodrigo N Carvalho 2026</div>

    <script>
        const DATA_LIMITE = new Date('2030-01-01'); if(new Date()>DATA_LIMITE)throw new Error("Bloqueado");
        let dbEstoque=[],dbClientes=[],carrinho=[],trocas=[],totalVendaGlobal=0,valorTaxaAplicada=0,parcelasSelecionadas=0,taxasAtuais={},mostrarTaxasNaTela=true;

        window.onload=function(){
            const cargo=localStorage.getItem('cargoUsuario');
            const btnVoltar=document.getElementById('btn-voltar-main');
            const btnBI=document.getElementById('btn-bi-admin');
            if(cargo==='admin'){btnVoltar.href="menu.html";btnBI.style.display='inline-flex';}else{btnVoltar.href="index.html";btnBI.style.display='none';}
            carregarOpcoesPagamento(); restaurarRascunho(); carregarTaxasDoBanco();
            db.collection("estoque").onSnapshot(snap=>{if(snap.empty)return;dbEstoque=[];snap.forEach(doc=>{const data=doc.data();if(!data.status||data.status.toLowerCase()!=="vendido")dbEstoque.push({id:doc.id,...data});});renderizarProdutos();});
            db.collection("clientes").orderBy("nome").onSnapshot(snap=>{dbClientes=[];snap.forEach(doc=>dbClientes.push({id:doc.id,...doc.data()}));renderizarDatalistClientes();});
            carregarListasAuxiliares();
        };

        function preVisualizar(){
            const cli = document.getElementById('cliente-input').value;
            if(carrinho.length===0) return alert("Carrinho Vazio!");
            const dados = montarDadosDoc(cli, false); // False = TÃ­tulo Recibo de Venda
            dados.titulo = "RECIBO DE VENDA"; // ForÃ§a tÃ­tulo
            dados.autoPrint = false;
            localStorage.setItem('dadosRecibo', JSON.stringify(dados));
            window.open('orcamento.html','_blank');
        }

        async function finalizar(isOrcamento){
            const cli=document.getElementById('cliente-input').value;
            const pg=document.getElementById('forma-pagamento').value;
            if(carrinho.length===0)return alert("Vazio!");
            if(!cli)return alert("Selecione Cliente");
            
            // SE FOR ORÃ‡AMENTO, NÃƒO VALIDA PAGAMENTO
            if(!isOrcamento && !pg) return alert("Selecione Pagamento");

            const tipo = isOrcamento ? "ORÃ‡AMENTO" : "VENDA";
            if(!confirm(`Confirmar ${tipo}?`)) return;

            try {
                const b = db.batch();
                if(!isOrcamento) {
                    carrinho.forEach(i=>{b.update(db.collection("estoque").doc(i.id),{status:"vendido",dataVenda:Date.now(),clienteVenda:cli});});
                    trocas.forEach(t=>{const r=db.collection("estoque").doc();b.set(r,{categoria:'celular',modelo:`${t.modelo} (TROCA)`,venda:0,status:'disponÃ­vel',custo:t.valor});});
                } else {
                    carrinho.forEach(i=>{b.update(db.collection("estoque").doc(i.id),{status:"disponÃ­vel"});});
                }

                // Salva Venda
                const snap = await db.collection("vendas").get();
                const num = String(snap.size+1).padStart(4,'0');
                b.set(db.collection("vendas").doc(),{numeroPedido:num, tipoRegistro:tipo, status: isOrcamento?"ORCAMENTO":"CONCRETIZADA", cliente:cli, total:totalVendaGlobal, data:new Date().toISOString()});
                await b.commit();

                // HistÃ³rico Cliente
                let txt = `${new Date().toLocaleDateString('pt-BR')} - ${isOrcamento?"OrÃ§amento":"Compra"}: R$ ${totalVendaGlobal.toFixed(2)}`;
                db.collection("clientes").where("nome","==",cli).get().then(qs=>{qs.forEach(doc=>{db.collection("clientes").doc(doc.id).update({historico: txt+"\n"+(doc.data().historico||"")})})});

                const dados = montarDadosDoc(cli, isOrcamento);
                dados.numeroPedido = num;
                dados.autoPrint = !isOrcamento; // Imprime se for venda
                localStorage.setItem('dadosRecibo', JSON.stringify(dados));
                window.open('orcamento.html','_blank');

                if(!isOrcamento) { limparRascunho(); window.location.reload(); }
                else { alert("OrÃ§amento salvo! Tela mantida."); }

            } catch(e) { alert("Erro: "+e.message); }
        }

        function montarDadosDoc(cli, isOrcamento){
            const cFull = dbClientes.find(c=>c.nome===cli)||{nome:cli};
            let itensR = carrinho.map(i=>({nome:i.modelo||i.nomeP,desc:i.cor||'',preco:i.venda,isBrinde:i.isBrinde}));
            trocas.forEach(t=>itensR.push({nome:"TROCA: "+t.modelo,desc:t.imei,preco:-t.valor,isTroca:true}));
            let textoParcela = "";
            if(parcelasSelecionadas>0) textoParcela = `(${parcelasSelecionadas}x)`;
            
            return {
                titulo: isOrcamento ? "ORÃ‡AMENTO" : "RECIBO DE VENDA",
                isOrcamento: isOrcamento,
                numeroPedido: "0000", // SerÃ¡ substituido
                cliente: cFull.nome, cpf: cFull.cpf||'', tel: cFull.whats||'', endereco: cFull.logradouro||'',
                itens: itensR,
                descontoManual: parseFloat(document.getElementById('valor-desconto-manual').value)||0,
                taxaMaquininha: valorTaxaAplicada,
                total: totalVendaGlobal,
                pagamento: document.getElementById('forma-pagamento').value,
                textoParcelas: textoParcela,
                data: new Date().toLocaleDateString('pt-BR')
            };
        }

        // FunÃ§Ãµes curtas de suporte
        function formatMoeda(v){return parseFloat(v).toLocaleString('pt-br',{style:'currency',currency:'BRL'});}
        function carregarTaxasDoBanco(){db.collection("config_taxas").doc("geral").onSnapshot(doc=>{if(doc.exists)taxasAtuais=doc.data();else taxasAtuais={1:4.5,12:15.5};});}
        function abrirSimulador(){if(totalVendaGlobal<=0)return alert("Vazio!");renderizarTabelaSimulacao(totalVendaGlobal);document.getElementById('modal-simulador').style.display='flex';}
        function renderizarTabelaSimulacao(base){const tb=document.getElementById('lista-simulacao');tb.innerHTML="";let txtCopy=`*SIMULAÃ‡ÃƒO*\nValor: ${formatMoeda(base)}\n`;for(let i=1;i<=24;i++){let tx=taxasAtuais[i]||(4+(i*1.2));let tot=base*(1+(tx/100));let parc=tot/i;let htmTx=mostrarTaxasNaTela?`<small>(${tx.toFixed(2)}%)</small>`:'';tb.innerHTML+=`<tr onclick="aplicarParcelamento(${i},${tot-base})"><td>${i}x ${htmTx}</td><td>${formatMoeda(parc)}</td><td class="sim-total">${formatMoeda(tot)}</td></tr>`;txtCopy+=`${i}x ${formatMoeda(parc)} (Total: ${formatMoeda(tot)})\n`;}document.getElementById('modal-simulador').setAttribute('data-copy',txtCopy);}
        function aplicarParcelamento(p,jur){valorTaxaAplicada=jur;parcelasSelecionadas=p;let s=document.getElementById('forma-pagamento');s.innerHTML+=`<option value="CrÃ©dito ${p}x">CrÃ©dito ${p}x (Simulado)</option>`;s.value=`CrÃ©dito ${p}x`;document.getElementById('modal-simulador').style.display='none';atualizarTotais();}
        function toggleTaxasVisuais(){mostrarTaxasNaTela=!mostrarTaxasNaTela;renderizarTabelaSimulacao(totalVendaGlobal);}
        function copiarOfertaZap(){navigator.clipboard.writeText(document.getElementById('modal-simulador').getAttribute('data-copy'));alert("Copiado!");}
        function carregarListasAuxiliares(){db.collection("lista_modelos_cel").onSnapshot(s=>{let d=document.getElementById('dl-modelos-list');d.innerHTML="";s.forEach(o=>d.innerHTML+=`<option value="${o.data().nome}">`)});db.collection("lista_cores_cel").onSnapshot(s=>{let d=document.getElementById('dl-cores-list');d.innerHTML="";s.forEach(o=>d.innerHTML+=`<option value="${o.data().nome}">`)});}
        function filtrarProdutos(){const t=document.getElementById('busca').value.toLowerCase();const c=document.getElementById('filtro-cat').value;document.querySelectorAll('.product-card').forEach(el=>{const txt=el.innerText.toLowerCase();const cat=el.querySelector('.prod-cat-tag').innerText.toLowerCase();el.style.display=(txt.includes(t)&&(c===""||cat.includes(c)))?'flex':'none'});}
        function renderizarDatalistClientes(){const dl=document.getElementById('lista-clientes-db');dl.innerHTML="";dbClientes.forEach(c=>dl.innerHTML+=`<option value="${c.nome}">${c.cpf||''}</option>`);}
        async function adicionarAoCarrinho(p){try{await db.collection("estoque").doc(p.id).update({status:"em_negociacao"});carrinho.push({...p,isBrinde:false});atualizarTotais();salvarRascunho();}catch(e){alert("Item indisponÃ­vel!");}}
        async function removerDoCarrinho(i){try{await db.collection("estoque").doc(carrinho[i].id).update({status:"disponÃ­vel"});}catch(e){}carrinho.splice(i,1);atualizarTotais();salvarRascunho();}
        async function cancelarVendaTotal(){if(!confirm("Limpar?"))return;for(const i of carrinho){try{await db.collection("estoque").doc(i.id).update({status:"disponÃ­vel"});}catch(e){}}limparRascunho();}
        function toggleBrinde(i){carrinho[i].isBrinde=!carrinho[i].isBrinde;atualizarTotais();}
        function confirmarTroca(){const t={modelo:document.getElementById('troca-modelo').value,imei:document.getElementById('troca-imei').value,valor:parseFloat(document.getElementById('troca-valor').value)||0};if(!t.modelo||!t.valor)return alert("Dados?");trocas.push(t);document.getElementById('modal-troca').style.display='none';atualizarTotais();}
        function atualizarTotais(){const dc=document.getElementById('carrinho-lista');const dt=document.getElementById('lista-trocas');dc.innerHTML="";dt.innerHTML="";let sub=0;carrinho.forEach((i,idx)=>{let val=i.isBrinde?0:parseFloat(i.venda||0);sub+=val;dc.innerHTML+=`<div class="cart-item ${i.isBrinde?'brinde':''}"><div class="item-info"><div>${i.modelo||i.nomeP}</div><small>R$ ${val.toFixed(2)}</small></div><div class="item-actions"><i class="btn-icon fas fa-gift" onclick="toggleBrinde(${idx})"></i><i class="btn-icon fas fa-trash" onclick="removerDoCarrinho(${idx})"></i></div></div>`;});let dTroca=0;trocas.forEach((t,i)=>{dTroca+=t.valor;dt.innerHTML+=`<div class="trade-in-box"><span>${t.modelo} (R$ ${t.valor})</span></div>`;});let desc=parseFloat(document.getElementById('valor-desconto-manual').value)||0;totalVendaGlobal=sub-dTroca-desc+valorTaxaAplicada;document.getElementById('valor-subtotal').innerText=`R$ ${sub.toFixed(2)}`;document.getElementById('valor-total').innerText=`R$ ${totalVendaGlobal.toFixed(2)}`;salvarRascunho();}
        function salvarRascunho(){localStorage.setItem('pdv_rascunho',JSON.stringify({carrinho,trocas,cli:document.getElementById('cliente-input').value,pg:document.getElementById('forma-pagamento').value}));}
        function restaurarRascunho(){let d=JSON.parse(localStorage.getItem('pdv_rascunho'));if(d){carrinho=d.carrinho||[];trocas=d.trocas||[];document.getElementById('cliente-input').value=d.cli||"";atualizarTotais();}}
        function limparRascunho(){localStorage.removeItem('pdv_rascunho');carrinho=[];trocas=[];valorTaxaAplicada=0;document.getElementById('cliente-input').value="";atualizarTotais();}
        function carregarOpcoesPagamento(){let s=document.getElementById('forma-pagamento');s.innerHTML=`<option value="">Selecione...</option><option>Pix</option><option>Dinheiro</option><option>DÃ©bito</option><option>CrÃ©dito</option>`;}
    </script>
</body>
</html>
