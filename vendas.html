<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√âRTICE | PDV</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        :root {
            --bg: #020617; --card: #0f172a; --accent: #00e0ff; --text: #f8fafc;
            --success: #10b981; --danger: #ef4444; --border: #1e293b;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR (Igual ao Admin) */
        .sidebar { width: 250px; background: #000; border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        .logo { color: var(--accent); text-align: center; font-weight: bold; font-size: 24px; margin-bottom: 40px; letter-spacing: 2px; }
        .nav-item { padding: 15px; color: #94a3b8; text-decoration: none; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: 0.3s; cursor: pointer; }
        .nav-item:hover, .nav-item.active { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0, 224, 255, 0.3); font-weight: bold; }
        .nav-item.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; } /* Para bloquear links do vendedor */

        /* CONTE√öDO */
        .main-content { flex: 1; display: flex; overflow: hidden; }
        
        /* √ÅREA DE PRODUTOS */
        .products-area { flex: 2; padding: 20px; overflow-y: auto; border-right: 1px solid var(--border); }
        .search-bar { width: 100%; padding: 15px; background: var(--card); border: 1px solid var(--border); color: #fff; border-radius: 10px; margin-bottom: 20px; font-size: 16px; outline: none; }
        .search-bar:focus { border-color: var(--accent); }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .product-card { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 10px; cursor: pointer; transition: 0.2s; position: relative; }
        .product-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .p-model { font-weight: bold; margin-bottom: 5px; display: block; }
        .p-price { color: var(--success); font-weight: bold; font-size: 1.1em; }
        .p-detail { font-size: 12px; color: #94a3b8; }

        /* CARRINHO */
        .cart-area { flex: 1; background: #050b14; padding: 20px; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
        .cart-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--accent); display: flex; justify-content: space-between; }
        .cart-list { flex: 1; overflow-y: auto; margin-bottom: 20px; border-top: 1px solid #334155; }
        .cart-item { padding: 10px 0; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .remove-btn { color: var(--danger); cursor: pointer; }
        
        .total-box { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .final-price { font-size: 28px; font-weight: bold; color: var(--success); text-align: right; margin-top: 10px; }

        .btn-checkout { width: 100%; padding: 15px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; text-transform: uppercase; }
        .btn-checkout:hover { background: #fff; }
        .btn-actions { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-small { flex: 1; padding: 10px; background: #334155; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        .btn-small:hover { background: #475569; }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">V√âRTICE</div>
        <nav>
            <a href="admin.html" class="nav-item" id="link-admin"><i class="fas fa-chart-pie"></i> Dashboard</a>
            
            <a href="#" class="nav-item active"><i class="fas fa-cash-register"></i> PDV (Caixa)</a>
            <a href="#" class="nav-item disabled"><i class="fas fa-box"></i> Estoque</a>
            <a href="#" class="nav-item disabled"><i class="fas fa-users"></i> Clientes</a>
            
            <div style="margin-top: auto; padding: 10px; background: #1e293b; border-radius: 8px; margin-bottom: 10px;">
                <div style="font-size: 11px; color: #94a3b8;">Logado como:</div>
                <div style="font-weight: bold; color: #fff;" id="user-display">...</div>
            </div>
            <a href="index.html" class="nav-item" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </nav>
    </aside>

    <div class="main-content">
        <div class="products-area">
            <input type="text" id="busca" class="search-bar" placeholder="üîç Buscar por Modelo, Marca ou IMEI..." onkeyup="filtrarProdutos()">
            
            <div class="products-grid" id="grid-produtos">
                <p style="color: #aaa;">Carregando sistema...</p>
            </div>
        </div>

        <div class="cart-area">
            <div class="cart-title">
                Carrinho <span style="font-size: 14px; background: var(--accent); color: #000; padding: 2px 8px; border-radius: 10px;" id="count-itens">0</span>
            </div>
            
            <div class="cart-list" id="lista-carrinho">
                <div style="text-align: center; margin-top: 50px; color: #64748b;">
                    <i class="fas fa-shopping-basket" style="font-size: 30px; margin-bottom: 10px;"></i><br>Caixa Livre
                </div>
            </div>

            <div class="total-box">
                <div class="total-row"><span>Subtotal</span> <span id="lbl-sub">R$ 0,00</span></div>
                <div class="total-row"><span>Desconto</span> <span id="lbl-desc" style="color: var(--danger);">R$ 0,00</span></div>
                <div class="final-price" id="lbl-total">R$ 0,00</div>
            </div>

            <div class="btn-actions">
                <button class="btn-small" onclick="limparCarrinho()"><i class="fas fa-trash"></i> Limpar</button>
                <button class="btn-small" onclick="aplicarDesconto()"><i class="fas fa-percent"></i> Desconto</button>
            </div>
            <button class="btn-checkout" onclick="finalizarVenda()">Finalizar Venda</button>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        let carrinho = [];
        let produtosEstoque = [];
        let totalVenda = 0;
        let descontoVenda = 0;

        // INICIALIZA√á√ÉO
        window.onload = async function() {
            // 1. Verifica Login
            const user = localStorage.getItem('usuarioLogado');
            const cargo = localStorage.getItem('cargoUsuario');
            
            if(!user) { window.location.href = 'index.html'; return; }
            document.getElementById('user-display').innerText = user.toUpperCase();

            // 2. Seguran√ßa de Menu
            if(cargo !== 'admin') {
                // Se for vendedor, esconde/bloqueia o bot√£o do Dashboard
                const linkAdmin = document.getElementById('link-admin');
                linkAdmin.style.opacity = '0.3';
                linkAdmin.style.pointerEvents = 'none'; // N√£o deixa clicar
                linkAdmin.innerHTML += ' <i class="fas fa-lock" style="font-size:10px;"></i>';
            }

            // 3. Carrega Produtos
            await carregarEstoque();
        };

        async function carregarEstoque() {
            const grid = document.getElementById('grid-produtos');
            
            try {
                // Tenta carregar 'estoque' (min√∫sculo)
                const snapshot = await db.collection("estoque").where("status", "==", "dispon√≠vel").get();
                
                if(snapshot.empty) {
                    // Se n√£o achar nada, tenta 'Estoque' (Mai√∫sculo) por garantia
                    const snapshotB = await db.collection("Estoque").where("status", "==", "dispon√≠vel").get();
                    if(!snapshotB.empty) processarDados(snapshotB);
                    else grid.innerHTML = '<p>Nenhum produto dispon√≠vel.</p>';
                } else {
                    processarDados(snapshot);
                }

            } catch (e) {
                console.error(e);
                grid.innerHTML = `<p style="color: #ef4444;">Erro de conex√£o: ${e.message}</p>`;
            }
        }

        function processarDados(snap) {
            produtosEstoque = [];
            snap.forEach(doc => produtosEstoque.push({ id: doc.id, ...doc.data() }));
            renderizar(produtosEstoque);
        }

        function renderizar(lista) {
            const grid = document.getElementById('grid-produtos');
            grid.innerHTML = "";
            
            lista.forEach(p => {
                // Corre√ß√£o monet√°ria
                let preco = 0;
                if(p.venda) {
                    let v = p.venda.toString().replace('R$', '').trim();
                    if(v.includes(',')) v = v.replace('.', '').replace(',', '.');
                    preco = parseFloat(v);
                }

                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => addCarrinho(p, preco);
                card.innerHTML = `
                    <span class="p-model">${p.modelo || 'Sem Modelo'}</span>
                    <span class="p-detail">${p.marca || ''} ‚Ä¢ ${p.cor || ''}</span>
                    <div class="p-price">R$ ${preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                `;
                grid.appendChild(card);
            });
        }

        function filtrarProdutos() {
            const termo = document.getElementById('busca').value.toLowerCase();
            const filtrados = produtosEstoque.filter(p => 
                (p.modelo && p.modelo.toLowerCase().includes(termo)) || 
                (p.marca && p.marca.toLowerCase().includes(termo)) ||
                (p.imei && p.imei.includes(termo))
            );
            renderizar(filtrados);
        }

        // --- CARRINHO ---
        function addCarrinho(produto, preco) {
            if(carrinho.find(x => x.id === produto.id)) return Swal.fire("Ops", "Item j√° no carrinho!", "warning");
            
            carrinho.push({ ...produto, precoReal: preco });
            atualizarCarrinho();
        }

        function removerItem(idx) {
            carrinho.splice(idx, 1);
            atualizarCarrinho();
        }

        function atualizarCarrinho() {
            const divLista = document.getElementById('lista-carrinho');
            divLista.innerHTML = "";
            let subtotal = 0;

            carrinho.forEach((item, idx) => {
                subtotal += item.precoReal;
                divLista.innerHTML += `
                    <div class="cart-item">
                        <div>
                            <strong>${item.modelo}</strong><br>
                            <span style="font-size:11px; color:#aaa;">${item.imei || ''}</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span>R$ ${item.precoReal.toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
                            <i class="fas fa-trash remove-btn" onclick="removerItem(${idx})"></i>
                        </div>
                    </div>
                `;
            });

            totalVenda = subtotal - descontoVenda;
            if(totalVenda < 0) totalVenda = 0;

            document.getElementById('lbl-sub').innerText = subtotal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('lbl-desc').innerText = "- " + descontoVenda.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('lbl-total').innerText = totalVenda.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('count-itens').innerText = carrinho.length;
        }

        function limparCarrinho() {
            carrinho = [];
            descontoVenda = 0;
            atualizarCarrinho();
        }

        async function aplicarDesconto() {
            const { value } = await Swal.fire({
                title: 'Desconto (R$)',
                input: 'number',
                background: '#1e293b', color: '#fff'
            });
            if(value) {
                descontoVenda = parseFloat(value);
                atualizarCarrinho();
            }
        }

        // --- FINALIZAR ---
        async function finalizarVenda() {
            if(carrinho.length === 0) return Swal.fire("Vazio", "Adicione produtos!", "warning");

            const { value: dados } = await Swal.fire({
                title: 'Finalizar',
                html: `
                    <input id="cli" class="swal2-input" placeholder="Nome Cliente">
                    <select id="pag" class="swal2-input">
                        <option>Pix</option><option>Dinheiro</option><option>Cart√£o</option>
                    </select>`,
                focusConfirm: false,
                background: '#1e293b', color: '#fff',
                preConfirm: () => {
                    return { cli: document.getElementById('cli').value, pag: document.getElementById('pag').value }
                }
            });

            if(!dados || !dados.cli) return;

            // Salvar
            try {
                const venda = {
                    data: new Date().toISOString(),
                    cliente: dados.cli,
                    pagamento: dados.pag,
                    total: document.getElementById('lbl-total').innerText,
                    desconto: descontoVenda,
                    itens: carrinho.map(x => ({ modelo: x.modelo, preco: x.precoReal })),
                    vendedor: localStorage.getItem('usuarioLogado')
                };

                await db.collection("vendas").add(venda);

                // Baixa Estoque
                const batch = db.batch();
                carrinho.forEach(item => {
                    batch.update(db.collection("estoque").doc(item.id), { status: 'vendido', dataVenda: new Date().toISOString() });
                    // Tenta tamb√©m cole√ß√£o Mai√∫scula por seguran√ßa
                    // batch.update(db.collection("Estoque").doc(item.id), ... ) -> Se soubermos o ID certo
                });
                await batch.commit();

                localStorage.setItem('dadosRecibo', JSON.stringify(venda));
                window.open('orcamento.html', '_blank');
                
                limparCarrinho();
                carregarEstoque(); // Recarrega para sumir os vendidos

            } catch(e) {
                Swal.fire("Erro", "Falha ao gravar venda", "error");
            }
        }
    </script>
</body>
</html>
