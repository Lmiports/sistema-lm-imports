<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V칄RTICE BI | PDV</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="logo.png" type="image/png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        /* --- PADR츾O V칄RTICE BI CORE --- */
        :root { --bg: #020617; --card: #0f172a; --accent: #00e0ff; --text: #f8fafc; --success: #10b981; --danger: #ef4444; --border: #1e293b; }

        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }

        /* HEADER */
        .header { height: 60px; background: #0f172a; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .logo-area { font-size: 18px; font-weight: 900; letter-spacing: 1px; color: var(--accent); }
        .logo-area span { color: #fff; font-size: 12px; opacity: 0.7; font-weight: 400; margin-left: 5px; }
        
        .btn-voltar { color: #94a3b8; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .btn-voltar:hover { color: #fff; }

        /* LAYOUT PRINCIPAL */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* ESQUERDA: LISTA DE PRODUTOS */
        .products-area { flex: 1.4; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow-y: hidden; }
        
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; background: #1e293b; border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: #fff; outline: none; }
        .search-input:focus { border-color: var(--accent); }
        
        .filter-tags { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .tag { padding: 6px 12px; background: #1e293b; border-radius: 20px; font-size: 11px; color: #94a3b8; cursor: pointer; white-space: nowrap; transition: 0.2s; border: 1px solid transparent; }
        .tag.active { background: var(--accent); color: #000; font-weight: bold; }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; overflow-y: auto; padding-bottom: 80px; align-content: start; }
        
        .product-card { 
            background: #1e293b; border: 1px solid var(--border); border-radius: 10px; padding: 12px; cursor: pointer; transition: 0.2s; position: relative; display: flex; flex-direction: column; justify-content: space-between; height: 130px; 
        }
        .product-card:active { transform: scale(0.95); }
        .product-card:hover { border-color: var(--accent); background: #253045; }
        
        .p-cat { font-size: 9px; text-transform: uppercase; color: #94a3b8; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .p-name { font-size: 13px; font-weight: 600; line-height: 1.3; color: #fff; margin-bottom: auto; }
        .p-price { font-size: 15px; font-weight: bold; color: var(--success); margin-top: 8px; }
        .p-stock { font-size: 10px; color: #fff; background: #334155; padding: 2px 6px; border-radius: 4px; }

        /* DIREITA: CARRINHO */
        .cart-area { flex: 1; background: #020617; display: flex; flex-direction: column; border-left: 1px solid var(--border); position: relative; }
        .cart-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
        
        .cart-list { flex: 1; overflow-y: auto; padding: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid transparent; }
        .cart-item:hover { border-color: rgba(255,255,255,0.1); }
        
        .ci-info div { font-size: 13px; color: #fff; }
        .ci-info small { font-size: 10px; color: #94a3b8; }
        .ci-price { font-weight: bold; color: var(--success); }
        .ci-remove { color: var(--danger); cursor: pointer; padding: 5px; margin-left: 10px; }

        .cart-footer { padding: 20px; background: #0f172a; border-top: 1px solid var(--border); }
        .cart-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #fff; }
        .btn-checkout { width: 100%; padding: 15px; background: var(--success); color: #000; font-weight: 900; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; text-transform: uppercase; }
        .btn-checkout:disabled { background: #334155; cursor: not-allowed; color: #94a3b8; }

        /* MODAL CHECKOUT */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1e293b; width: 400px; padding: 25px; border-radius: 15px; border: 1px solid var(--border); box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .modal h2 { margin-top: 0; color: #fff; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid var(--border); border-radius: 6px; color: #fff; outline: none; box-sizing: border-box; }
        
        .pay-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .pay-btn { padding: 10px; background: #0f172a; border: 1px solid var(--border); color: #94a3b8; border-radius: 6px; cursor: pointer; text-align: center; font-size: 12px; font-weight: bold; }
        .pay-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        .btn-finalizar { width: 100%; padding: 12px; background: var(--success); border: none; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer; color: #000; margin-top: 10px; }
        .btn-cancel { width: 100%; padding: 10px; background: transparent; border: none; color: #ef4444; margin-top: 10px; cursor: pointer; }

        /* MOBILE */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; overflow-y: auto; }
            .products-area { overflow-y: visible; border-right: none; padding-bottom: 0; }
            .products-grid { grid-template-columns: repeat(2, 1fr); padding-bottom: 0; }
            .cart-area { border-top: 1px solid var(--border); height: auto; }
            .cart-list { max-height: 200px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo-area">V칄RTICE<span>PDV</span></div>
        <a href="menu.html" class="btn-voltar"><i class="fas fa-arrow-left"></i> Menu</a>
    </div>

    <div class="main-container">
        
        <div class="products-area">
            <div class="search-bar">
                <input type="text" id="busca" class="search-input" placeholder="Buscar produto..." onkeyup="renderizarProdutos()">
            </div>

            <div class="filter-tags">
                <div class="tag active" onclick="filtrar('todos', this)">Todos</div>
                <div class="tag" onclick="filtrar('celular', this)">Celulares</div>
                <div class="tag" onclick="filtrar('acessorio', this)">Acess칩rios</div>
                <div class="tag" onclick="filtrar('roupa', this)">Roupas</div>
                <div class="tag" onclick="filtrar('perfume', this)">Perfumes</div>
            </div>

            <div class="products-grid" id="gridProdutos">
                </div>
        </div>

        <div class="cart-area">
            <div class="cart-header">
                <span>CARRINHO</span>
                <i class="fas fa-shopping-cart"></i>
            </div>

            <div class="cart-list" id="listaCarrinho">
                <div style="text-align:center; color:#64748b; margin-top:50px; font-size:12px;">Carrinho vazio</div>
            </div>

            <div class="cart-footer">
                <div class="cart-total">
                    <span>Total</span>
                    <span id="totalValor">R$ 0,00</span>
                </div>
                <button id="btnCheckout" class="btn-checkout" onclick="abrirCheckout()" disabled>FINALIZAR VENDA</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalCheckout">
        <div class="modal-content">
            <h2>Finalizar Venda</h2>
            
            <div class="form-group">
                <label>Nome do Cliente</label>
                <input type="text" id="cliNome" class="form-input" placeholder="Nome do cliente">
            </div>

            <div class="form-group">
                <label>Forma de Pagamento</label>
                <div class="pay-options">
                    <div class="pay-btn active" onclick="selPag('PIX', this)">PIX</div>
                    <div class="pay-btn" onclick="selPag('DINHEIRO', this)">DINHEIRO</div>
                    <div class="pay-btn" onclick="selPag('CART츾O', this)">CART츾O</div>
                    <div class="pay-btn" onclick="selPag('PARCELADO', this)">PARCELADO</div>
                </div>
                <input type="hidden" id="pagamento" value="PIX">
            </div>

            <div class="form-group">
                <label>Desconto (R$)</label>
                <input type="number" id="desconto" class="form-input" placeholder="0.00" onkeyup="atualizarTotalFinal()">
            </div>

            <div style="font-size:18px; font-weight:bold; text-align:center; margin:15px 0; color:var(--accent);">
                Total: <span id="modalTotal">R$ 0,00</span>
            </div>

            <button class="btn-finalizar" id="btnConfirmar" onclick="confirmarVenda()">CONFIRMAR VENDA</button>
            <button class="btn-cancel" onclick="fecharCheckout()">Cancelar</button>
        </div>
    </div>

    <script>
        // --- 游 SEGURAN칂A ---
        const DATA_LIMITE = new Date('2030-01-01'); 
        if(new Date() > DATA_LIMITE) throw new Error("Bloqueado");

        let estoque = [];
        let carrinho = []; // Lista de IDs que est칚o no carrinho
        let filtroAtual = 'todos';

        window.onload = () => {
            const user = localStorage.getItem('usuarioLogado');
            if(!user) window.location.href='index.html';
            carregarEstoque();
        };

        function carregarEstoque() {
            db.collection("estoque").where("status", "==", "dispon칤vel").onSnapshot(snap => {
                estoque = [];
                snap.forEach(doc => estoque.push({ id: doc.id, ...doc.data() }));
                renderizarProdutos();
            });
        }

        // --- RENDERIZA칂츾O COM AGRUPAMENTO INTELIGENTE (IGUAL AO ESTOQUE) ---
        function renderizarProdutos() {
            const grid = document.getElementById('gridProdutos');
            grid.innerHTML = "";
            const busca = document.getElementById('busca').value.toLowerCase();

            // 1. Filtrar
            const filtrados = estoque.filter(p => {
                const texto = (p.modelo + (p.imei1||'')).toLowerCase();
                const matchTexto = texto.includes(busca);
                const matchCat = filtroAtual === 'todos' || (p.categoria||'').toLowerCase().includes(filtroAtual);
                return matchTexto && matchCat;
            });

            // 2. Agrupar
            const listaExibicao = [];
            const grupos = {};
            const norm = (str) => (str || '').toString().trim().toLowerCase();

            filtrados.forEach(p => {
                const cat = (p.categoria || '').toLowerCase();
                
                // Celulares n칚o agrupam (cliente escolhe espec칤fico por bateria/imei)
                if (cat.includes('celular')) {
                    listaExibicao.push(p);
                } else {
                    // Chave de grupo para Outros (Perfume, Capa, etc)
                    const chave = `${norm(p.modelo)}|${norm(p.venda)}|${norm(p.cor)}|${norm(p.tamanho)}|${norm(p.ml)}|${norm(p.fragrancia)}`;
                    
                    if (!grupos[chave]) {
                        grupos[chave] = { 
                            ...p, 
                            isGroup: true, 
                            idsDisponiveis: [], // IDs REAIS dispon칤veis para venda
                            count: 0
                        };
                        listaExibicao.push(grupos[chave]);
                    }
                    grupos[chave].count++;
                    grupos[chave].idsDisponiveis.push(p.id);
                }
            });

            // 3. Desenhar Cards
            listaExibicao.forEach(item => {
                // Se for grupo, calcula quantos restam fora do carrinho
                let qtdVisivel = 0;
                let idsParaVender = [];

                if (item.isGroup) {
                    // Filtra IDs que J츼 est칚o no carrinho
                    idsParaVender = item.idsDisponiveis.filter(id => !carrinho.find(c => c.id === id));
                    qtdVisivel = idsParaVender.length;
                    
                    // Se todos j치 est칚o no carrinho, n칚o mostra na lista (ou mostra disabled)
                    if (qtdVisivel === 0) return;
                } else {
                    // Se item individual j치 t치 no carrinho, n칚o mostra
                    if (carrinho.find(c => c.id === item.id)) return;
                    qtdVisivel = 1;
                    idsParaVender = [item.id];
                }

                const el = document.createElement('div');
                el.className = 'product-card';
                // Ao clicar, adiciona o PRIMEIRO ID dispon칤vel do grupo
                el.onclick = () => adicionarAoCarrinho(item, idsParaVender[0]);

                let infoExtra = item.gb || item.tamanho || item.ml || item.cor || '';
                
                // Badge de Quantidade
                let badgeStock = item.isGroup ? `${qtdVisivel} un` : '1 un';

                el.innerHTML = `
                    <div class="p-cat">
                        <span>${(item.categoria||'').toUpperCase()}</span>
                        <span class="p-stock">${badgeStock}</span>
                    </div>
                    <div class="p-name">${item.modelo} <br><small style="opacity:0.6; font-weight:400;">${infoExtra}</small></div>
                    <div class="p-price">${formatMoney(item.venda)}</div>
                `;
                grid.appendChild(el);
            });
        }

        function adicionarAoCarrinho(itemOriginal, idReal) {
            // Busca o objeto completo original pelo ID real (para ter os dados certos)
            const produtoReal = estoque.find(p => p.id === idReal);
            if (!produtoReal) return;

            carrinho.push(produtoReal);
            atualizarCarrinhoUI();
            renderizarProdutos(); // Re-renderiza para atualizar contadores/esconder itens
        }

        function removerDoCarrinho(index) {
            carrinho.splice(index, 1);
            atualizarCarrinhoUI();
            renderizarProdutos(); // Devolve item pra lista
        }

        function atualizarCarrinhoUI() {
            const lista = document.getElementById('listaCarrinho');
            lista.innerHTML = "";
            let total = 0;

            if (carrinho.length === 0) {
                lista.innerHTML = '<div style="text-align:center; color:#64748b; margin-top:50px; font-size:12px;">Carrinho vazio</div>';
                document.getElementById('btnCheckout').disabled = true;
                document.getElementById('totalValor').innerText = "R$ 0,00";
                return;
            }

            carrinho.forEach((item, index) => {
                total += parseFloat(item.venda || 0);
                let info = item.gb || item.tamanho || item.ml || '';
                
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div class="ci-info">
                        <div>${item.modelo}</div>
                        <small>${info} | ${item.cor||''}</small>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span class="ci-price">${formatMoney(item.venda)}</span>
                        <i class="fas fa-trash ci-remove" onclick="removerDoCarrinho(${index})"></i>
                    </div>
                `;
                lista.appendChild(div);
            });

            document.getElementById('totalValor').innerText = formatMoney(total);
            document.getElementById('btnCheckout').disabled = false;
        }

        function filtrar(cat, btn) {
            filtroAtual = cat;
            document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderizarProdutos();
        }

        // --- CHECKOUT ---
        function abrirCheckout() {
            document.getElementById('modalCheckout').style.display = 'flex';
            document.getElementById('cliNome').focus();
            atualizarTotalFinal();
        }

        function fecharCheckout() {
            document.getElementById('modalCheckout').style.display = 'none';
        }

        function selPag(tipo, btn) {
            document.getElementById('pagamento').value = tipo;
            document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function atualizarTotalFinal() {
            let total = carrinho.reduce((acc, i) => acc + (parseFloat(i.venda)||0), 0);
            let desc = parseFloat(document.getElementById('desconto').value) || 0;
            let final = total - desc;
            document.getElementById('modalTotal').innerText = formatMoney(final);
        }

        async function confirmarVenda() {
            const btn = document.getElementById('btnConfirmar');
            const cliente = document.getElementById('cliNome').value.trim() || "Consumidor Final";
            const pag = document.getElementById('pagamento').value;
            const desc = parseFloat(document.getElementById('desconto').value) || 0;
            
            let subtotal = carrinho.reduce((acc, i) => acc + (parseFloat(i.venda)||0), 0);
            let totalFinal = subtotal - desc;

            btn.disabled = true;
            btn.innerText = "PROCESSANDO...";

            try {
                const batch = db.batch();

                // 1. Atualizar status dos itens no estoque
                carrinho.forEach(item => {
                    const ref = db.collection("estoque").doc(item.id);
                    batch.update(ref, { 
                        status: 'vendido',
                        dataVenda: new Date().toISOString()
                    });
                });

                // 2. Criar registro da venda
                const vendaRef = db.collection("vendas").doc();
                const dadosVenda = {
                    data: new Date().toISOString(),
                    cliente: cliente,
                    pagamento: pag,
                    itens: carrinho.map(i => ({
                        id: i.id,
                        modelo: i.modelo,
                        venda: i.venda,
                        custo: i.custo || 0 // Salva o custo hist칩rico para o BI
                    })),
                    subtotal: subtotal,
                    desconto: desc,
                    total: totalFinal,
                    vendedor: localStorage.getItem('usuarioLogado')
                };
                
                batch.set(vendaRef, dadosVenda);

                await batch.commit();

                alert("Venda realizada com sucesso!");
                window.location.reload(); // Recarrega para limpar tudo

            } catch (error) {
                console.error(error);
                alert("Erro ao finalizar: " + error);
                btn.disabled = false;
                btn.innerText = "CONFIRMAR VENDA";
            }
        }

        function formatMoney(val) { return parseFloat(val).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
    </script>
</body>
</html>
