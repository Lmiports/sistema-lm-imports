<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Vendas e Trocas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #020617;
            --card: #0f172a;
            --accent: #00e0ff;
            --text: #f8fafc;
            --border: rgba(255, 255, 255, 0.1);
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #eab308;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border);
        }
        .header h2 { margin: 0; color: var(--accent); letter-spacing: 2px; }
        .btn-voltar { color: #fff; text-decoration: none; font-size: 20px; }

        /* LAYOUT PRINCIPAL */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }

        /* √ÅREA DE PRODUTOS */
        .products-section { display: flex; flex-direction: column; gap: 15px; overflow-y: hidden; }

        .search-box { display: flex; gap: 10px; }
        .search-box input, .search-box select {
            width: 100%; padding: 12px; background: var(--card); border: 1px solid var(--border);
            color: #fff; border-radius: 8px; outline: none;
        }

        .products-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px; overflow-y: auto; padding-right: 5px;
        }

        .product-card {
            background: var(--card); border: 1px solid var(--border); border-radius: 10px;
            padding: 15px; cursor: pointer; transition: 0.2s; position: relative;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .product-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        
        .prod-cat-tag {
            font-size: 10px; text-transform: uppercase; background: rgba(0, 224, 255, 0.1); 
            color: var(--accent); padding: 4px 8px; border-radius: 4px; width: fit-content; margin-bottom: 5px; font-weight: bold;
        }

        .prod-name { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .prod-detail { font-size: 11px; color: #94a3b8; margin-bottom: 5px; }
        .prod-price { color: var(--success); font-weight: bold; font-size: 16px; margin-top: auto; }
        .prod-stock { 
            font-size: 10px; position: absolute; top: 10px; right: 10px; 
            background: #334155; padding: 2px 6px; border-radius: 4px; 
        }

        /* CARRINHO */
        .cart-section {
            background: var(--card); border-radius: 15px; border: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column;
        }

        .client-area { margin-bottom: 15px; }
        .client-row { display: flex; gap: 5px; }
        .client-row select {
            width: 100%; padding: 10px; background: #1e293b; border: 1px solid var(--border);
            color: #fff; border-radius: 5px;
        }
        .btn-add-client {
            background: var(--success); color: #000; border: none; width: 40px; border-radius: 5px;
            cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;
        }

        .cart-items {
            flex: 1; overflow-y: auto; margin-bottom: 15px; 
            border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 10px 0;
        }

        .cart-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin-bottom: 8px;
        }
        .item-info div { font-size: 13px; font-weight: bold; }
        .btn-remove { color: var(--danger); cursor: pointer; padding: 5px; }

        /* TROCA */
        .trade-in-box {
            background: rgba(234, 179, 8, 0.1); border: 1px solid var(--warning);
            padding: 10px; border-radius: 8px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .trade-in-text { font-size: 12px; color: var(--warning); }

        /* TOTAIS E BOT√ïES */
        .totals { margin-bottom: 15px; font-size: 14px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .total-final { font-size: 24px; font-weight: 900; color: var(--success); border-top: 1px solid var(--border); padding-top: 10px; }

        .btn-finalizar { background: var(--success); color: #000; padding: 15px; width: 100%; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-troca { background: transparent; border: 1px solid var(--warning); color: var(--warning); padding: 10px; width: 100%; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .btn-recibo { background: #eab308; color: #000; padding: 15px; width: 100%; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }

        /* MODAIS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal { 
            background: var(--card); padding: 25px; border-radius: 15px; 
            width: 400px; max-width: 90%; max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--border); 
        }
        .modal input { width: 100%; padding: 10px; margin: 5px 0; background: #1e293b; border: 1px solid var(--border); color: #fff; border-radius: 5px; box-sizing: border-box; }
        .modal h3 { margin-top: 0; color: var(--accent); }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn-cancel { flex: 1; padding: 10px; background: #334155; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        .btn-confirm { flex: 1; padding: 10px; background: var(--success); color: #000; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }

        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; overflow-y: auto; }
            .cart-section { margin-top: 20px; }
            body { height: auto; }
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="btn-voltar"><i class="fas fa-arrow-left"></i></a>
        <h2>PDV | VENDAS</h2>
        <div></div>
    </div>

    <div class="main-grid">
        
        <div class="products-section">
            <div class="search-box">
                <input type="text" id="busca" placeholder="Buscar produto..." onkeyup="filtrarProdutos()">
                <select id="filtro-cat" onchange="filtrarProdutos()" style="width: 150px;">
                    <option value="">Todas</option>
                    <option value="Roupa">üëï Roupas</option>
                    <option value="Celular">üì± Celulares</option>
                    <option value="Perfume">üå∏ Perfumes</option>
                    <option value="Acessorio">üéß Acess√≥rios</option>
                </select>
            </div>

            <div class="products-list" id="lista-produtos">
                </div>
        </div>

        <div class="cart-section">
            <div class="client-area">
                <label style="font-size: 12px; color: #94a3b8;">Cliente:</label>
                <div class="client-row">
                    <select id="cliente-select">
                        <option value="">Selecionar Cliente...</option>
                    </select>
                    <button class="btn-add-client" onclick="abrirModalCliente()" title="Novo Cliente Completo">+</button>
                </div>
            </div>

            <div class="cart-items" id="carrinho-lista">
                <div style="text-align: center; color: #64748b; margin-top: 20px;">Carrinho vazio</div>
            </div>

            <div id="lista-trocas"></div>

            <div class="totals">
                <div class="row"><span>Subtotal:</span><span id="valor-subtotal">R$ 0,00</span></div>
                <div class="row" style="color: var(--warning);"><span>Troca/Desc:</span><span id="valor-desconto">- R$ 0,00</span></div>
                <div class="row total-final"><span>TOTAL:</span><span id="valor-total">R$ 0,00</span></div>
            </div>

            <div style="margin-bottom: 10px;">
                <label style="font-size: 12px;">Pagamento:</label>
                <select id="forma-pagamento" style="width: 100%; padding: 8px; background: #1e293b; color: #fff; border: 1px solid var(--border); border-radius: 5px;">
                    </select>
            </div>

            <button class="btn-troca" onclick="abrirModalTroca()"><i class="fas fa-exchange-alt"></i> Entrada de Troca</button>
            <button class="btn-finalizar" onclick="finalizarVenda()"><i class="fas fa-check"></i> FINALIZAR VENDA</button>
            <button class="btn-recibo" onclick="gerarRecibo()"><i class="fas fa-file-contract"></i> RECIBO & CONTRATO</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-troca">
        <div class="modal" style="border-color: var(--warning);">
            <h3 style="color: var(--warning);">Entrada de Troca</h3>
            <input type="text" id="troca-modelo" placeholder="Modelo (Ex: iPhone 11)">
            <input type="number" id="troca-valor" placeholder="Valor Avaliado (R$)">
            <input type="number" id="troca-bateria" placeholder="Sa√∫de Bateria (%)">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="fecharModalTroca()" class="btn-cancel">Cancelar</button>
                <button onclick="confirmarTroca()" class="btn-confirm" style="background: var(--warning);">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-cliente">
        <div class="modal">
            <h3>Novo Cliente Completo</h3>
            <label style="font-size: 12px; color: #888;">Dados Pessoais</label>
            <input type="text" id="novo-nome" placeholder="Nome Completo (Obrigat√≥rio)">
            <div class="modal-grid">
                <input type="text" id="novo-zap" placeholder="WhatsApp">
                <input type="text" id="novo-cpf" placeholder="CPF">
            </div>
            <input type="email" id="novo-email" placeholder="Email">

            <label style="font-size: 12px; color: #888; margin-top: 10px; display: block;">Endere√ßo (Busca Autom√°tica)</label>
            <div class="modal-grid">
                <input type="text" id="novo-cep" placeholder="CEP (S√≥ n√∫meros)" onblur="buscarCep()">
                <input type="text" id="novo-numero" placeholder="N√∫mero">
            </div>
            <input type="text" id="novo-endereco" placeholder="Rua / Avenida">
            <div class="modal-grid">
                <input type="text" id="novo-bairro" placeholder="Bairro">
                <input type="text" id="novo-cidade" placeholder="Cidade - UF">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="fecharModalCliente()" class="btn-cancel">Cancelar</button>
                <button onclick="salvarNovoCliente()" class="btn-confirm">Salvar Cadastro</button>
            </div>
        </div>
    </div>

    <script>
        // BANCOS DE DADOS
        let db_produtos = JSON.parse(localStorage.getItem('db_estoque')) || [];
        let db_clientes = JSON.parse(localStorage.getItem('db_clientes')) || [];
        let db_vendas = JSON.parse(localStorage.getItem('db_vendas')) || [];
        let db_caixa = JSON.parse(localStorage.getItem('db_caixa')) || [];
        let db_fornecedores = JSON.parse(localStorage.getItem('db_fornecedores')) || [];

        let carrinho = [];
        let trocas = [];

        window.onload = function() {
            carregarProdutos();
            carregarClientes();
            carregarOpcoesPagamento(); // Nova fun√ß√£o para os parcelamentos
        };

        // --- GERA AS OP√á√ïES DE PAGAMENTO (1x a 24x) ---
        function carregarOpcoesPagamento() {
            const select = document.getElementById('forma-pagamento');
            select.innerHTML = `
                <optgroup label="√Ä Vista">
                    <option value="Pix">Pix</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="D√©bito">D√©bito</option>
                </optgroup>
                <optgroup label="Cr√©dito Parcelado">
            `;
            
            // Loop para criar de 1x at√© 24x
            for (let i = 1; i <= 24; i++) {
                const option = document.createElement('option');
                option.value = `Cr√©dito ${i}x`;
                option.innerText = `Cr√©dito ${i}x`;
                select.appendChild(option);
            }
        }

        // --- BUSCA CEP AUTOM√ÅTICA ---
        function buscarCep() {
            const cep = document.getElementById('novo-cep').value.replace(/\D/g, '');
            if (cep.length === 8) {
                document.getElementById('novo-endereco').value = "Buscando...";
                
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.erro) {
                            document.getElementById('novo-endereco').value = data.logradouro;
                            document.getElementById('novo-bairro').value = data.bairro;
                            document.getElementById('novo-cidade').value = `${data.localidade} - ${data.uf}`;
                            document.getElementById('novo-numero').focus(); // Joga o foco pro n√∫mero
                        } else {
                            alert("CEP n√£o encontrado.");
                            document.getElementById('novo-endereco').value = "";
                        }
                    })
                    .catch(() => alert("Erro ao buscar CEP."));
            }
        }

        // --- MODAIS E CADASTRO ---
        function abrirModalCliente() { document.getElementById('modal-cliente').style.display = 'flex'; }
        function fecharModalCliente() { document.getElementById('modal-cliente').style.display = 'none'; }

        function salvarNovoCliente() {
            const nome = document.getElementById('novo-nome').value;
            if (!nome) { alert("Nome √© obrigat√≥rio!"); return; }

            const novoCliente = {
                id: Date.now(),
                nome: nome,
                contato: document.getElementById('novo-zap').value,
                cpf: document.getElementById('novo-cpf').value,
                email: document.getElementById('novo-email').value,
                cep: document.getElementById('novo-cep').value,
                endereco: document.getElementById('novo-endereco').value,
                numero: document.getElementById('novo-numero').value,
                bairro: document.getElementById('novo-bairro').value,
                cidade: document.getElementById('novo-cidade').value,
                historico: []
            };

            db_clientes.push(novoCliente);
            localStorage.setItem('db_clientes', JSON.stringify(db_clientes));
            carregarClientes();
            document.getElementById('cliente-select').value = nome; 
            document.querySelectorAll('#modal-cliente input').forEach(input => input.value = '');
            fecharModalCliente();
            alert("Cliente cadastrado com sucesso!");
        }

        // --- PRODUTOS COM AS SUAS CATEGORIAS ---
        function carregarProdutos() {
            const lista = document.getElementById('lista-produtos');
            lista.innerHTML = '';
            
            db_produtos.forEach(prod => {
                if (prod.qtd > 0) {
                    const div = document.createElement('div');
                    div.className = 'product-card';
                    div.onclick = () => adicionarAoCarrinho(prod.id);
                    
                    // SELE√á√ÉO DE √çCONES CONFORME SUA LISTA
                    let iconCat = 'üì¶';
                    if(prod.categoria === 'Celular') iconCat = 'üì±';
                    if(prod.categoria === 'Acessorio') iconCat = 'üéß';
                    if(prod.categoria === 'Perfume') iconCat = 'üå∏';
                    if(prod.categoria === 'Roupa') iconCat = 'üëï';

                    div.innerHTML = `
                        <span class="prod-cat-tag">${iconCat} ${prod.categoria || 'Outros'}</span>
                        <span class="prod-stock">${prod.qtd} un</span>
                        <span class="prod-name">${prod.modelo}</span>
                        <span class="prod-detail">${prod.cor} | ${prod.gb || ''}</span>
                        <span class="prod-price">R$ ${parseFloat(prod.pvenda).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    `;
                    lista.appendChild(div);
                }
            });
        }

        function filtrarProdutos() {
            const termo = document.getElementById('busca').value.toLowerCase();
            const cat = document.getElementById('filtro-cat').value; 
            
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const textoCard = card.innerText.toLowerCase();
                // Pegamos o texto da categoria de dentro do HTML gerado
                // Ex: "üì± Celular" cont√©m "celular"
                const catTag = card.querySelector('.prod-cat-tag').innerText.toLowerCase();
                
                // O filtro verifica se a tag do produto CONT√âM o valor do select
                // Ex: Select "Roupa" -> Tag "üëï Roupa" (Match!)
                const matchNome = textoCard.includes(termo);
                const matchCat = cat === "" || catTag.includes(cat.toLowerCase());

                card.style.display = (matchNome && matchCat) ? 'flex' : 'none';
            });
        }

        // --- MANIPULA√á√ÉO DE DADOS ---
        function carregarClientes() {
            const select = document.getElementById('cliente-select');
            const valorAtual = select.value;
            select.innerHTML = '<option value="">Selecionar Cliente...</option>';
            db_clientes.forEach(cli => {
                const opt = document.createElement('option');
                opt.value = cli.nome;
                opt.innerText = cli.nome;
                select.appendChild(opt);
            });
            select.value = valorAtual;
        }

        function adicionarAoCarrinho(id) {
            const produto = db_produtos.find(p => p.id === id);
            carrinho.push(produto);
            atualizarCarrinho();
        }

        function removerDoCarrinho(index) {
            carrinho.splice(index, 1);
            atualizarCarrinho();
        }

        function abrirModalTroca() { document.getElementById('modal-troca').style.display = 'flex'; }
        function fecharModalTroca() { document.getElementById('modal-troca').style.display = 'none'; }

        function confirmarTroca() {
            const modelo = document.getElementById('troca-modelo').value;
            const valor = parseFloat(document.getElementById('troca-valor').value);
            const bateria = document.getElementById('troca-bateria').value;

            if (modelo && valor) {
                trocas.push({ modelo, valor, bateria });
                fecharModalTroca();
                atualizarCarrinho();
                document.getElementById('troca-modelo').value = '';
                document.getElementById('troca-valor').value = '';
                document.getElementById('troca-bateria').value = '';
            } else { alert("Preencha modelo e valor!"); }
        }

        function removerTroca(index) {
            trocas.splice(index, 1);
            atualizarCarrinho();
        }

        function atualizarCarrinho() {
            const divCarrinho = document.getElementById('carrinho-lista');
            const divTrocas = document.getElementById('lista-trocas');
            
            divCarrinho.innerHTML = '';
            let subtotal = 0;
            carrinho.forEach((item, index) => {
                subtotal += parseFloat(item.pvenda);
                divCarrinho.innerHTML += `
                    <div class="cart-item">
                        <div class="item-info"><div>${item.modelo}</div><small>R$ ${item.pvenda}</small></div>
                        <i class="fas fa-trash btn-remove" onclick="removerDoCarrinho(${index})"></i>
                    </div>`;
            });

            divTrocas.innerHTML = '';
            let totalTroca = 0;
            trocas.forEach((item, index) => {
                totalTroca += item.valor;
                divTrocas.innerHTML += `
                    <div class="trade-in-box">
                        <div class="trade-in-text"><strong>ENTRADA:</strong> ${item.modelo} <br><small>Bat: ${item.bateria}% | Valor: R$ ${item.valor}</small></div>
                        <i class="fas fa-times btn-remove" onclick="removerTroca(${index})"></i>
                    </div>`;
            });

            const totalFinal = subtotal - totalTroca;
            window.totalVendaGlobal = totalFinal; 
            document.getElementById('valor-subtotal').innerText = subtotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('valor-desconto').innerText = '- ' + totalTroca.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('valor-total').innerText = totalFinal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        }

        function gerarRecibo() {
            const clienteNome = document.getElementById('cliente-select').value;
            const pagto = document.getElementById('forma-pagamento').value;
            if (carrinho.length === 0) { alert("Carrinho vazio!"); return; }

            let itensRecibo = carrinho.map(i => ({ nome: i.modelo, desc: i.cor, preco: i.pvenda }));
            trocas.forEach(t => {
                itensRecibo.push({ nome: "TROCA: " + t.modelo, desc: "Bat: " + t.bateria + "%", preco: -t.valor });
            });

            // BUSCA DADOS COMPLETOS DO CLIENTE PARA O RECIBO
            const clienteFull = db_clientes.find(c => c.nome === clienteNome) || {};

            const dadosVenda = {
                cliente: clienteNome,
                cpf: clienteFull.cpf || "",
                tel: clienteFull.contato || "",
                endereco: clienteFull.endereco ? `${clienteFull.endereco}, ${clienteFull.numero} - ${clienteFull.bairro}` : "",
                itens: itensRecibo,
                total: window.totalVendaGlobal,
                pagamento: pagto,
                data: new Date().toLocaleDateString('pt-BR')
            };

            localStorage.setItem('dadosRecibo', JSON.stringify(dadosVenda));
            window.location.href = 'orcamento.html';
        }

        function finalizarVenda() {
            const clienteNome = document.getElementById('cliente-select').value;
            if (carrinho.length === 0) { alert("Carrinho vazio!"); return; }
            if (!clienteNome) { alert("Selecione um cliente!"); return; }

            carrinho.forEach(item => {
                const prod = db_produtos.find(p => p.id === item.id);
                if (prod) prod.qtd--;
            });

            trocas.forEach(troca => {
                db_produtos.push({
                    id: Date.now() + Math.random(),
                    modelo: `${troca.modelo} (TROCA: ${clienteNome})`,
                    cor: "Usado", gb: "", categoria: "Celular",
                    pcusto: troca.valor, pvenda: 0, qtd: 1,
                    dataEntrada: new Date().toLocaleDateString('pt-BR'),
                    obs: `Bat: ${troca.bateria}% | Origem: Troca`
                });
            });
            
             if (trocas.length > 0) {
                const fornecedorExiste = db_fornecedores.find(f => f.nome === clienteNome);
                if (!fornecedorExiste) {
                    db_fornecedores.push({ id: Date.now(), nome: clienteNome, contato: "Cliente da Loja", tipo: "Cliente / Troca" });
                    localStorage.setItem('db_fornecedores', JSON.stringify(db_fornecedores));
                }
            }

            db_vendas.push({
                id: Date.now(), data: new Date().toLocaleDateString('pt-BR'),
                cliente: clienteNome, total: window.totalVendaGlobal,
                itens: carrinho.map(i=>i.modelo).join(', '), trocas: trocas.map(t=>t.modelo).join(', '),
                pagamento: document.getElementById('forma-pagamento').value
            });

            localStorage.setItem('db_estoque', JSON.stringify(db_produtos));
            localStorage.setItem('db_vendas', JSON.stringify(db_vendas));
            alert("VENDA FINALIZADA!");
            window.location.reload();
        }
    </script>
</body>
</html>