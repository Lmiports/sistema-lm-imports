<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√âRTICE - GEST√ÉO DE FORNECEDORES</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #3b82f6; --border: #1e293b; --text: #f8fafc; --success: #10b981; --danger: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: #000; border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; transition: 0.3s; }
        .logo { color: var(--accent); text-align: center; font-weight: bold; font-size: 20px; margin-bottom: 40px; letter-spacing: 2px; }
        .nav-item { padding: 15px; color: #94a3b8; text-decoration: none; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: var(--accent); color: #fff; }

        /* CONTENT */
        .content { flex: 1; padding: 20px; display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; overflow-y: auto; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .card-header { padding: 15px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 14px; font-weight: bold; color: var(--accent); text-transform: uppercase; margin: 0; }

        /* LISTA (ESQUERDA) */
        .search-box { padding: 15px; border-bottom: 1px solid var(--border); }
        .list-container { flex: 1; overflow-y: auto; }
        
        .list-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: 0.2s; cursor: pointer; }
        .list-item:hover { background: rgba(59, 130, 246, 0.1); }
        .list-item.active { background: var(--accent); color: #fff; }
        .list-item.active .list-meta { color: #e2e8f0; }

        .list-name { font-weight: bold; font-size: 14px; }
        .list-meta { font-size: 11px; color: #94a3b8; margin-top: 3px; display: flex; align-items: center; gap: 5px; }

        /* FORMUL√ÅRIO (DIREITA) */
        .form-body { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .label { font-size: 10px; text-transform: uppercase; color: #64748b; font-weight: bold; margin-bottom: 5px; display: block; }
        
        input, textarea { width: 100%; padding: 12px; background: #020617; border: 1px solid var(--border); border-radius: 8px; color: #fff; outline: none; box-sizing: border-box; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--accent); }
        
        /* BOT√ïES */
        .btn-group { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; background: var(--card); }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-save { background: var(--success); color: #000; }
        .btn-new { background: var(--accent); color: #fff; }
        .btn-del { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        
        /* CEP */
        .cep-wrapper { display: flex; gap: 10px; }
        .btn-search { background: var(--accent); color: #fff; border: none; width: 42px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* MENU MOBILE ICON */
        .menu-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; background: var(--accent); color: white; border: none; padding: 8px; border-radius: 5px; }

        /* --- RESPONSIVIDADE MOBILE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; height: auto; padding-top: 50px; }
            
            .menu-toggle { display: block; }
            .sidebar { 
                position: fixed; top: 0; left: -250px; height: 100vh; z-index: 1000; 
                background: rgba(0,0,0,0.95); width: 250px; 
            }
            .sidebar.active { left: 0; }

            .content { 
                display: flex; 
                flex-direction: column; 
                height: auto; 
                overflow: visible;
                padding: 10px;
            }

            /* Lista de Fornecedores menor no topo */
            .card:first-child {
                max-height: 300px; 
                flex: none;
            }
            .list-container { max-height: 200px; }

            /* Formul√°rio vira coluna √∫nica */
            .form-grid { grid-template-columns: 1fr; }
            
            /* Ajuste espec√≠fico para o grid CEP */
            .form-grid[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }

            .form-body { overflow: visible; height: auto; }
            
            /* Bot√µes */
            .btn { width: 100%; justify-content: center; }
            .btn-group { flex-direction: column-reverse; }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('active')">
        <i class="fas fa-bars"></i>
    </button>

    <aside class="sidebar">
        <div class="logo">V√âRTICE</div>
        <nav>
            <a href="index.html" class="nav-item"><i class="fas fa-home"></i> In√≠cio</a>
            <a href="clientes.html" class="nav-item"><i class="fas fa-users"></i> Clientes</a>
            <a href="fornecedores.html" class="nav-item active"><i class="fas fa-truck"></i> Fornecedores</a>
            <a href="estoque.html" class="nav-item"><i class="fas fa-box"></i> Estoque</a>
            <a href="vendas.html" class="nav-item"><i class="fas fa-cash-register"></i> PDV Vendas</a>
        </nav>
    </aside>

    <main class="content">
        
        <section class="card">
            <div class="card-header">
                <h3 class="card-title">Parceiros</h3>
                <span style="font-size:10px; color:#64748b" id="total-items">0 registros</span>
            </div>
            <div class="search-box">
                <input type="text" id="busca" placeholder="üîç Buscar fornecedor..." onkeyup="filtrarLista()">
            </div>
            <div class="list-container" id="listaFornecedores">
                <div style="padding:20px; text-align:center; color:#64748b;">Carregando...</div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border);">
                <button class="btn btn-new" style="width:100%; justify-content:center;" onclick="novoItem()">
                    <i class="fas fa-plus"></i> NOVO FORNECEDOR
                </button>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h3 class="card-title">Ficha Cadastral</h3>
                <input type="hidden" id="itemId">
            </div>
            
            <div class="form-body">
                <div>
                    <label class="label">Raz√£o Social / Nome Fantasia</label>
                    <input type="text" id="nome" placeholder="Ex: Distribuidora Alpha">
                </div>

                <div class="form-grid">
                    <div>
                        <label class="label">CNPJ</label>
                        <input type="text" id="cnpj" placeholder="00.000.000/0000-00">
                    </div>
                    <div>
                        <label class="label">WhatsApp</label>
                        <input type="text" id="whats" placeholder="(11) 99999-9999">
                    </div>
                </div>

                <div class="form-grid" style="grid-template-columns: 1fr 2fr;">
                    <div>
                        <label class="label">CEP</label>
                        <div class="cep-wrapper">
                            <input type="text" id="cep" placeholder="00000-000" maxlength="9">
                            <button class="btn-search" onclick="buscarCEP()"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="label">Endere√ßo (Auto)</label>
                        <input type="text" id="endereco" readonly style="color:#94a3b8; cursor:not-allowed;">
                    </div>
                </div>

                <div class="form-grid">
                    <div>
                        <label class="label">E-mail</label>
                        <input type="email" id="email" placeholder="contato@empresa.com">
                    </div>
                    <div>
                        <label class="label">Instagram</label>
                        <input type="text" id="insta" placeholder="@...">
                    </div>
                </div>

                <div>
                    <label class="label">Hist√≥rico / Observa√ß√µes</label>
                    <textarea id="historico" style="height:100px;" placeholder="Principais produtos, condi√ß√µes de pagamento, etc..."></textarea>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-del" onclick="deletarItem()">
                    <i class="fas fa-trash"></i> Excluir
                </button>
                <button class="btn btn-save" onclick="salvarItem()">
                    <i class="fas fa-save"></i> SALVAR DADOS
                </button>
            </div>
        </section>

    </main>

    <script>
        let dbItens = [];
        let itemSelecionadoId = null;

        // 1. INICIALIZA√á√ÉO
        window.onload = () => {
            db.collection("fornecedores").orderBy("nome").onSnapshot(snap => {
                dbItens = [];
                snap.forEach(doc => dbItens.push({ id: doc.id, ...doc.data() }));
                document.getElementById('total-items').innerText = `${dbItens.length} registros`;
                renderizarLista(dbItens);
            });
        };

        // 2. LISTAGEM
        function renderizarLista(lista) {
            const div = document.getElementById('listaFornecedores');
            div.innerHTML = "";
            
            lista.forEach(f => {
                const el = document.createElement('div');
                el.className = `list-item ${itemSelecionadoId === f.id ? 'active' : ''}`;
                el.onclick = () => carregarItem(f);
                
                // Bot√£o de Whats flutuante na lista
                let whatsLink = f.whats ? `
                    <a href="https://wa.me/55${f.whats.replace(/\D/g,'')}" target="_blank" onclick="event.stopPropagation()" style="color:${itemSelecionadoId === f.id ? '#fff' : 'var(--success)'}">
                        <i class="fab fa-whatsapp"></i>
                    </a>` : '';

                el.innerHTML = `
                    <div>
                        <div class="list-name">${f.nome}</div>
                        <div class="list-meta">
                            ${whatsLink}
                            <span>${f.cnpj || 'Sem CNPJ'}</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right" style="font-size:10px; opacity:0.5;"></i>
                `;
                div.appendChild(el);
            });
        }

        function filtrarLista() {
            const termo = document.getElementById('busca').value.toLowerCase();
            const filtrados = dbItens.filter(i => i.nome.toLowerCase().includes(termo));
            renderizarLista(filtrados);
        }

        // 3. FORMUL√ÅRIO
        function carregarItem(f) {
            itemSelecionadoId = f.id;
            document.getElementById('itemId').value = f.id;
            document.getElementById('nome').value = f.nome || '';
            document.getElementById('cnpj').value = f.cnpj || '';
            document.getElementById('whats').value = f.whats || '';
            document.getElementById('cep').value = f.cep || '';
            document.getElementById('endereco').value = f.endereco || '';
            document.getElementById('email').value = f.email || '';
            document.getElementById('insta').value = f.insta || '';
            document.getElementById('historico').value = f.historico || '';
            
            renderizarLista(dbItens);
            
            if(window.innerWidth <= 768) {
                document.querySelector('.form-body').scrollIntoView({behavior: "smooth"});
            }
        }

        function novoItem() {
            itemSelecionadoId = null;
            document.getElementById('itemId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('nome').focus();
            renderizarLista(dbItens);
            
            if(window.innerWidth <= 768) {
                document.querySelector('.form-body').scrollIntoView({behavior: "smooth"});
            }
        }

        // 4. CEP
        async function buscarCEP() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            if(cep.length !== 8) return;
            
            document.getElementById('endereco').placeholder = "Buscando...";
            const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await res.json();
            
            if(!data.erro) {
                document.getElementById('endereco').value = `${data.logradouro}, ${data.bairro} - ${data.localidade}/${data.uf}`;
            } else {
                alert("CEP n√£o encontrado.");
                document.getElementById('endereco').value = "";
            }
        }

        // 5. CRUD
        async function salvarItem() {
            const id = document.getElementById('itemId').value;
            const dados = {
                nome: document.getElementById('nome').value,
                cnpj: document.getElementById('cnpj').value,
                whats: document.getElementById('whats').value,
                cep: document.getElementById('cep').value,
                endereco: document.getElementById('endereco').value,
                email: document.getElementById('email').value,
                insta: document.getElementById('insta').value,
                historico: document.getElementById('historico').value,
                dataAtualizacao: Date.now()
            };

            if(!dados.nome) return alert("O Nome √© obrigat√≥rio.");

            try {
                if(id) {
                    await db.collection("fornecedores").doc(id).update(dados);
                    alert("Dados atualizados!");
                } else {
                    await db.collection("fornecedores").add(dados);
                    novoItem();
                    alert("Fornecedor cadastrado!");
                }
            } catch (e) { alert("Erro: " + e.message); }
        }

        async function deletarItem() {
            const id = document.getElementById('itemId').value;
            if(!id) return;
            if(confirm("Deseja excluir este fornecedor?")) {
                await db.collection("fornecedores").doc(id).delete();
                novoItem();
            }
        }
    </script>
</body>
</html>