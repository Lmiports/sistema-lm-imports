<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√âRTICE BI | CORE</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="logo.png" type="image/png">
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        /* --- PADR√ÉO VISUAL V√âRTICE BI CORE --- */
        :root { 
            --bg: #020617; 
            --card: #0f172a; 
            --accent: #00e0ff; /* AZUL NEON */
            --border: #1e293b; 
            --text: #f8fafc; 
            --success: #10b981; 
            --danger: #ef4444; 
        }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            display: block; 
            min-height: 100vh; 
            overflow-y: auto; 
            user-select: none; /* Evita sele√ß√£o no touch */
        }
        
        /* HEADER FIXO */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        
        /* Bot√£o Menu estilo APP */
        .btn-home {
            background: #1e293b;
            color: #fff;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border);
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .btn-home:hover { background: var(--accent); border-color: var(--accent); color: #000; }

        .page-title { font-size: 18px; font-weight: bold; color: var(--accent); letter-spacing: 1px; margin: 0; }
        .version-tag { font-size: 10px; color: #000; background: var(--accent); padding: 2px 6px; border-radius: 4px; margin-left: 10px; font-weight: 900; letter-spacing: 1px; vertical-align: middle; }

        /* CONTENT */
        .content { 
            padding: 20px; 
            display: grid; 
            grid-template-columns: 1fr 1.5fr; 
            gap: 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; height: fit-content; }
        .card-header { padding: 15px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 14px; font-weight: bold; color: var(--accent); text-transform: uppercase; margin: 0; }
        
        /* LISTA (ESQUERDA) */
        .search-box { padding: 15px; border-bottom: 1px solid var(--border); }
        input, textarea, select { width: 100%; padding: 12px; background: #020617; border: 1px solid var(--border); border-radius: 8px; color: #fff; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus, textarea:focus, select:focus { border-color: var(--accent); }
        
        .client-list { max-height: 600px; overflow-y: auto; flex: 1; }
        .client-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .client-item:hover { background: rgba(0, 224, 255, 0.1); }
        .client-item.active { background: var(--accent); color: #000; }
        .client-meta { font-size: 11px; color: #94a3b8; }
        .client-item.active .client-meta { color: #000; font-weight: bold; }

        /* FORMUL√ÅRIO (DIREITA) */
        .form-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .label { font-size: 11px; color: #64748b; margin-bottom: 5px; display: block; text-transform: uppercase; }
        
        .cep-wrapper { display: flex; gap: 10px; align-items: flex-end; }
        .btn-cep { background: var(--accent); color: #000; border: none; padding: 12px 15px; border-radius: 8px; cursor: pointer; height: 42px; width: 50px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn-cep:hover { background: #fff; }

        .historico-box { 
            background: #000; border: 1px solid var(--border); border-radius: 8px; 
            padding: 15px; color: #cbd5e1; font-family: 'Courier New', monospace; 
            font-size: 12px; line-height: 1.5; height: 150px; overflow-y: auto; white-space: pre-wrap;
        }

        /* BOT√ïES */
        .btn-group { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; background: var(--card); }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-save { background: var(--success); color: #000; }
        .btn-save:hover { filter: brightness(1.1); }
        .btn-new { background: var(--accent); color: #000; justify-content: center; width: 100%; }
        .btn-del { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-del:hover { background: var(--danger); color: #fff; }

        /* RODAP√â */
        .footer { text-align: center; padding: 20px; color: #64748b; font-size: 11px; border-top: 1px solid var(--border); margin-top: 20px; width: 100%; }

        /* RESPONSIVIDADE MOBILE */
        @media (max-width: 900px) {
            .content { display: flex; flex-direction: column; padding: 10px; }
            .card:first-child { max-height: 350px; } /* Lista menor no mobile */
            .form-grid { grid-template-columns: 1fr !important; }
            .btn-group { flex-direction: column-reverse; }
            .btn { width: 100%; justify-content: center; }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="header-top">
        <div class="header-left">
            <div onclick="window.location.href='menu.html'" class="btn-home"><i class="fas fa-home"></i> MENU</div>
            <h1 class="page-title">V√âRTICE BI <span class="version-tag">CORE</span></h1>
        </div>
        <div></div>
    </div>

    <main class="content">
        
        <section class="card">
            <div class="card-header">
                <h3 class="card-title">Base de Clientes</h3>
                <span style="font-size:10px; color:#64748b" id="total-clientes">0 cadastros</span>
            </div>
            <div class="search-box">
                <input type="text" id="busca" placeholder="üîç Buscar por nome ou CPF..." onkeyup="filtrarLista()">
            </div>
            <div class="client-list" id="lista-clientes">
                <div style="padding:20px; text-align:center; color:#64748b;">Carregando...</div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border);">
                <button class="btn btn-new" onclick="novoCliente()">
                    <i class="fas fa-plus"></i> NOVO CLIENTE
                </button>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-id-card"></i> Ficha Cadastral</h3>
                <input type="hidden" id="clienteId">
            </div>
            
            <div class="form-body">
                <div class="form-grid">
                    <div>
                        <label class="label">Nome Completo</label>
                        <input type="text" id="nome" placeholder="Nome do Cliente">
                    </div>
                    <div>
                        <label class="label">CPF</label>
                        <input type="text" id="cpf" placeholder="000.000.000-00">
                    </div>
                </div>

                <div class="form-grid">
                    <div>
                        <label class="label">WhatsApp</label>
                        <input type="text" id="whats" placeholder="(11) 99999-9999">
                    </div>
                    <div>
                        <label class="label">E-mail</label>
                        <input type="email" id="email" placeholder="cliente@email.com">
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid var(--border); width:100%; margin:10px 0;">

                <div class="form-grid" style="grid-template-columns: 1fr 3fr;">
                    <div>
                        <label class="label">CEP</label>
                        <div class="cep-wrapper">
                            <input type="text" id="cep" placeholder="00000-000" maxlength="9" onblur="buscarCep()">
                            <button class="btn-cep" onclick="buscarCep()"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="label">Rua / Logradouro</label>
                        <input type="text" id="logradouro" placeholder="Endere√ßo">
                    </div>
                </div>

                <div class="form-grid" style="grid-template-columns: 1fr 1fr 2fr;">
                    <div>
                        <label class="label">N√∫mero</label>
                        <input type="text" id="numero" placeholder="N¬∫">
                    </div>
                    <div>
                        <label class="label">Comp.</label>
                        <input type="text" id="complemento" placeholder="Ap 22">
                    </div>
                    <div>
                        <label class="label">Bairro</label>
                        <input type="text" id="bairro" placeholder="Bairro">
                    </div>
                </div>

                <div class="form-grid" style="grid-template-columns: 3fr 1fr;">
                    <div>
                        <label class="label">Cidade</label>
                        <input type="text" id="cidade" placeholder="Cidade">
                    </div>
                    <div>
                        <label class="label">UF</label>
                        <input type="text" id="uf" placeholder="UF" maxlength="2">
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label class="label" style="color:var(--accent);">
                        <i class="fas fa-history"></i> Hist√≥rico de Compras (Autom√°tico)
                    </label>
                    <textarea id="historico" class="historico-box" placeholder="Hist√≥rico vazio..."></textarea>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-del" onclick="deletarCliente()">
                    <i class="fas fa-trash"></i> Excluir
                </button>
                <button class="btn btn-save" onclick="salvarCliente()">
                    <i class="fas fa-save"></i> SALVAR DADOS
                </button>
            </div>
        </section>

        <div class="footer" style="grid-column: 1 / -1;">
            V√âRTICE BI CORE v11.0 ¬© Rodrigo N Carvalho 2026
        </div>

    </main>

    <script>
        // --- üîí KILL SWITCH ---
        const DATA_LIMITE = new Date('2030-01-01'); 
        if(new Date() > DATA_LIMITE) { 
            document.body.innerHTML = '<div style="height:100vh;display:flex;justify-content:center;align-items:center;background:#000;color:red;flex-direction:column;"><h1>ACESSO SUSPENSO</h1><p>Contate o suporte.</p></div>'; 
            throw new Error("Bloqueado"); 
        }

        let dbClientes = [];
        let clienteSelecionadoId = null;

        // INICIALIZA√á√ÉO
        window.onload = () => {
            const cargo = localStorage.getItem('cargoUsuario');
            if(!cargo) window.location.href='index.html';

            db.collection("clientes").orderBy("nome").onSnapshot(snap => {
                dbClientes = [];
                snap.forEach(doc => dbClientes.push({ id: doc.id, ...doc.data() }));
                document.getElementById('total-clientes').innerText = `${dbClientes.length} cadastros`;
                renderizarLista(dbClientes);
            });
        };

        // RENDERIZAR LISTA
        function renderizarLista(lista) {
            const div = document.getElementById('lista-clientes');
            div.innerHTML = "";
            lista.forEach(c => {
                const el = document.createElement('div');
                el.className = `client-item ${clienteSelecionadoId === c.id ? 'active' : ''}`;
                el.onclick = () => carregarFicha(c);
                el.innerHTML = `
                    <div>
                        <div style="font-weight:600;">${c.nome}</div>
                        <div class="client-meta">${c.whats || 'Sem contato'}</div>
                    </div>
                    <i class="fas fa-chevron-right" style="font-size:10px; opacity:0.5;"></i>
                `;
                div.appendChild(el);
            });
        }

        function filtrarLista() {
            const termo = document.getElementById('busca').value.toLowerCase();
            const filtrados = dbClientes.filter(c => 
                c.nome.toLowerCase().includes(termo) || 
                (c.cpf && c.cpf.includes(termo))
            );
            renderizarLista(filtrados);
        }

        // FORMUL√ÅRIO
        function carregarFicha(c) {
            clienteSelecionadoId = c.id;
            document.getElementById('clienteId').value = c.id;
            document.getElementById('nome').value = c.nome;
            document.getElementById('cpf').value = c.cpf || '';
            document.getElementById('whats').value = c.whats || '';
            document.getElementById('email').value = c.email || '';
            document.getElementById('historico').value = c.historico || '';
            
            // Dados de Endere√ßo
            document.getElementById('cep').value = c.cep || '';
            document.getElementById('logradouro').value = c.logradouro || c.endereco || '';
            document.getElementById('numero').value = c.numero || '';
            document.getElementById('complemento').value = c.complemento || '';
            document.getElementById('bairro').value = c.bairro || '';
            document.getElementById('cidade').value = c.cidade || '';
            document.getElementById('uf').value = c.uf || '';

            renderizarLista(dbClientes); 
            
            // No mobile, rola at√© o formul√°rio
            if(window.innerWidth <= 900) {
                document.querySelector('.form-body').scrollIntoView({behavior: "smooth"});
            }
        }

        function novoCliente() {
            clienteSelecionadoId = null;
            document.getElementById('clienteId').value = "";
            document.getElementById('nome').value = "";
            document.getElementById('cpf').value = "";
            document.getElementById('whats').value = "";
            document.getElementById('email').value = "";
            document.getElementById('historico').value = "";
            
            document.getElementById('cep').value = "";
            document.getElementById('logradouro').value = "";
            document.getElementById('numero').value = "";
            document.getElementById('complemento').value = "";
            document.getElementById('bairro').value = "";
            document.getElementById('cidade').value = "";
            document.getElementById('uf').value = "";

            document.getElementById('nome').focus();
            renderizarLista(dbClientes);
            
            if(window.innerWidth <= 900) {
                document.querySelector('.form-body').scrollIntoView({behavior: "smooth"});
            }
        }

        // BUSCA DE CEP AUTOM√ÅTICA
        function buscarCep() {
            let cep = document.getElementById('cep').value.replace(/\D/g, '');
            if (cep.length !== 8) return;

            document.getElementById('logradouro').placeholder = "Buscando...";
            
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(res => res.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('logradouro').value = data.logradouro;
                        document.getElementById('bairro').value = data.bairro;
                        document.getElementById('cidade').value = data.localidade;
                        document.getElementById('uf').value = data.uf;
                        document.getElementById('numero').focus();
                    } else {
                        alert("CEP n√£o encontrado!");
                        document.getElementById('logradouro').placeholder = "Rua / Logradouro";
                    }
                })
                .catch(() => alert("Sem conex√£o com ViaCEP."));
        }

        async function salvarCliente() {
            const id = document.getElementById('clienteId').value;
            
            const logradouro = document.getElementById('logradouro').value;
            const numero = document.getElementById('numero').value;
            const complemento = document.getElementById('complemento').value;
            const bairro = document.getElementById('bairro').value;
            const cidade = document.getElementById('cidade').value;
            const uf = document.getElementById('uf').value;

            // Endere√ßo completo para o PDV usar de forma simplificada
            const enderecoCompleto = `${logradouro}, N¬∫ ${numero} ${complemento ? '- ' + complemento : ''}, ${bairro}, ${cidade}-${uf}`;

            const dados = {
                nome: document.getElementById('nome').value,
                cpf: document.getElementById('cpf').value,
                whats: document.getElementById('whats').value,
                email: document.getElementById('email').value,
                historico: document.getElementById('historico').value,
                cep: document.getElementById('cep').value,
                logradouro: logradouro,
                numero: numero,
                complemento: complemento,
                bairro: bairro,
                cidade: cidade,
                uf: uf,
                endereco: enderecoCompleto 
            };

            if (!dados.nome) return alert("O Nome √© obrigat√≥rio.");

            try {
                if (id) {
                    await db.collection("clientes").doc(id).update(dados);
                    alert("Dados atualizados!");
                } else {
                    await db.collection("clientes").add(dados);
                    novoCliente();
                    alert("Cliente cadastrado com sucesso!");
                }
            } catch (e) { alert("Erro ao salvar: " + e.message); }
        }

        async function deletarCliente() {
            const id = document.getElementById('clienteId').value;
            if(!id) return;
            if(confirm("Deseja realmente excluir este cliente?")) {
                try {
                    await db.collection("clientes").doc(id).delete();
                    novoCliente();
                    alert("Cliente exclu√≠do.");
                } catch(e) { alert("Erro: " + e.message); }
            }
        }
    </script>
</body>
</html>
